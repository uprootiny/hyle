<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labyrinth — hyle</title>
    <meta name="description" content="Descent through mystical strata - Tractatus, I Ching, Hermetic, Borges, Zen">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>λ</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&family=Crimson+Pro:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050506;
            --bg-elevated: #0a0a0c;
            --bg-surface: #0f0f12;
            --text: #f0f0f3;
            --text-secondary: #a0a0ab;
            --text-muted: #606068;
            --accent: #10b981;
            --accent-bright: #34d399;
            --border: #1a1a20;
            --wall: #1a1a1e;
            --floor: #0d0d10;
            --item: #3b82f6;
            --stairs: #eab308;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'SF Mono', Consolas, monospace;
            --font-prose: 'Crimson Pro', Georgia, serif;
        }

        .level-0 { --accent: #e0e0e0; --accent-bright: #ffffff; --bg-surface: #08080a; --wall: #18181c; }
        .level-1 { --accent: #dc2626; --accent-bright: #fbbf24; --bg-surface: #120808; --wall: #1c1414; }
        .level-2 { --accent: #10b981; --accent-bright: #6ee7b7; --bg-surface: #081208; --wall: #141c14; }
        .level-3 { --accent: #6366f1; --accent-bright: #818cf8; --bg-surface: #080812; --wall: #14141c; }
        .level-4 { --accent: #a855f7; --accent-bright: #c084fc; --bg-surface: #100812; --wall: #1a141c; }
        .level-5 { --accent: #1a1a1a; --accent-bright: #2a2a2a; --bg-surface: #000000; --text: #333; --wall: #080808; }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: var(--font-sans);
            font-size: 14px;
            line-height: 1.6;
            min-height: 100vh;
            transition: all 0.8s;
        }

        nav {
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            background: rgba(5,5,6,0.9);
            backdrop-filter: blur(12px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text);
            text-decoration: none;
            font-weight: 600;
        }

        .brand .lambda { color: var(--accent); font-size: 1.25rem; transition: color 0.5s; }
        .brand:hover .lambda { color: var(--accent-bright); }

        .back-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.85rem;
            transition: color 0.2s;
        }

        .back-link:hover { color: var(--accent); }

        #game {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        #level-indicator {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 1.5rem;
            padding: 1rem 1.25rem;
            background: var(--bg-elevated);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        #level-name {
            font-weight: 600;
            color: var(--accent);
            font-size: 1rem;
            letter-spacing: 0.05em;
            transition: color 0.5s;
        }

        #level-subtitle {
            color: var(--text-muted);
            font-family: var(--font-prose);
            font-style: italic;
            font-size: 0.9rem;
            margin-left: 1rem;
        }

        #depth {
            color: var(--text-muted);
            font-family: var(--font-mono);
            font-size: 0.8rem;
        }

        /* Graphical Maze */
        #maze-container {
            background: var(--bg-elevated);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: center;
            overflow: hidden;
        }

        #maze-canvas {
            display: block;
            image-rendering: pixelated;
            border-radius: 4px;
        }

        #proposition {
            padding: 1rem 1.25rem;
            background: var(--bg-surface);
            border-left: 3px solid var(--accent);
            border-radius: 0 8px 8px 0;
            margin-bottom: 1rem;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            color: var(--accent);
            transition: all 0.5s;
        }

        #proposition .number {
            font-weight: 600;
            margin-right: 0.5rem;
        }

        #description {
            padding: 1.5rem 2rem;
            background: var(--bg-surface);
            border-left: 3px solid var(--border);
            border-radius: 0 12px 12px 0;
            margin-bottom: 1.5rem;
            min-height: 120px;
            font-family: var(--font-prose);
            font-size: 1.1rem;
            color: var(--text-secondary);
            line-height: 1.9;
            transition: all 0.5s;
        }

        #mechanic-hint {
            padding: 0.75rem 1rem;
            background: rgba(16, 185, 129, 0.08);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 6px;
            margin-bottom: 1.5rem;
            font-size: 0.85rem;
            color: var(--accent);
            display: none;
        }

        #status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            font-size: 0.85rem;
        }

        #inventory {
            color: var(--text-muted);
            font-family: var(--font-mono);
        }

        #inventory span { color: var(--accent); }

        #hint {
            color: var(--text-muted);
            font-style: italic;
        }

        #controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        button {
            background: var(--bg-elevated);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 0.6rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: var(--font-sans);
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        button:hover {
            border-color: var(--accent);
            background: rgba(16, 185, 129, 0.1);
        }

        button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        button:disabled:hover {
            border-color: var(--border);
            background: var(--bg-elevated);
        }

        button.descend {
            background: var(--accent);
            color: var(--bg);
            border-color: var(--accent);
        }

        button.descend:hover {
            background: var(--accent-bright);
            border-color: var(--accent-bright);
        }

        #divination {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-elevated);
            border: 1px solid var(--accent);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            z-index: 200;
            display: none;
            min-width: 280px;
        }

        #divination h3 {
            color: var(--accent);
            margin-bottom: 1rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        #divination .hexagram {
            font-size: 2rem;
            letter-spacing: 0.5rem;
            margin-bottom: 1rem;
            font-family: var(--font-mono);
        }

        #divination p {
            color: var(--text-muted);
            font-family: var(--font-prose);
            font-style: italic;
        }
    </style>
</head>
<body class="level-0">
    <nav>
        <a href="/" class="brand">
            <span class="lambda">λ</span>
            <span>hyle</span>
        </a>
        <a href="/projects/" class="back-link">← Projects</a>
    </nav>
    <div id="game">
        <div id="level-indicator">
            <div>
                <span id="level-name">I. Tractatus</span>
                <span id="level-subtitle"></span>
            </div>
            <span id="depth">stratum I</span>
        </div>
        <div id="maze-container">
            <canvas id="maze-canvas"></canvas>
        </div>
        <div id="proposition"></div>
        <div id="mechanic-hint"></div>
        <div id="description"></div>
        <div id="status">
            <div id="inventory">carrying: <span id="inv">nothing</span></div>
            <div id="hint"></div>
        </div>
        <div id="controls">
            <button onclick="move('n')" id="btn-n">↑ north</button>
            <button onclick="move('s')" id="btn-s">↓ south</button>
            <button onclick="move('w')" id="btn-w">← west</button>
            <button onclick="move('e')" id="btn-e">→ east</button>
            <button onclick="take()">take</button>
            <button onclick="descend()" id="btn-descend" class="descend" style="display:none">▼ descend</button>
        </div>
    </div>
    <div id="divination"></div>

    <script>
    // ═══════════════════════════════════════════════════════════════════════════
    // TRACTATUS LOGICO-PHILOSOPHICUS - Complete propositions in order
    // ═══════════════════════════════════════════════════════════════════════════

    const TRACTATUS = [
        { n: "1", t: "The world is all that is the case." },
        { n: "1.1", t: "The world is the totality of facts, not of things." },
        { n: "1.11", t: "The world is determined by the facts, and by their being all the facts." },
        { n: "1.12", t: "For the totality of facts determines what is the case, and also whatever is not the case." },
        { n: "1.13", t: "The facts in logical space are the world." },
        { n: "1.2", t: "The world divides into facts." },
        { n: "1.21", t: "Each item can be the case or not the case while everything else remains the same." },
        { n: "2", t: "What is the case—a fact—is the existence of states of affairs." },
        { n: "2.01", t: "A state of affairs (a state of things) is a combination of objects (things)." },
        { n: "2.011", t: "It is essential to things that they should be possible constituents of states of affairs." },
        { n: "2.012", t: "In logic nothing is accidental: if a thing can occur in a state of affairs, the possibility of the state of affairs must be written into the thing itself." },
        { n: "2.0121", t: "It would seem to be a sort of accident, if it turned out that a situation would fit a thing that could already exist entirely on its own." },
        { n: "2.0122", t: "Things are independent in so far as they can occur in all possible situations, but this form of independence is a form of connexion with states of affairs, a form of dependence." },
        { n: "2.0123", t: "If I know an object I also know all its possible occurrences in states of affairs." },
        { n: "2.0124", t: "If all objects are given, then at the same time all possible states of affairs are also given." },
        { n: "2.013", t: "Each thing is, as it were, in a space of possible states of affairs. This space I can imagine empty, but I cannot imagine the thing without the space." },
        { n: "2.014", t: "Objects contain the possibility of all situations." },
        { n: "2.0141", t: "The possibility of its occurring in states of affairs is the form of an object." },
        { n: "2.02", t: "Objects are simple." },
        { n: "2.021", t: "Objects make up the substance of the world. That is why they cannot be composite." },
        { n: "2.0211", t: "If the world had no substance, then whether a proposition had sense would depend on whether another proposition was true." },
        { n: "2.0212", t: "In that case we could not sketch any picture of the world (true or false)." },
        { n: "2.022", t: "It is obvious that an imagined world, however different it may be from the real one, must have something—a form—in common with it." },
        { n: "2.023", t: "Objects are just what constitute this unalterable form." },
        { n: "2.0231", t: "The substance of the world can only determine a form, and not any material properties." },
        { n: "2.0232", t: "In a manner of speaking, objects are colourless." },
        { n: "2.0233", t: "If two objects have the same logical form, the only distinction between them, apart from their external properties, is that they are different." },
        { n: "2.024", t: "Substance is what subsists independently of what is the case." },
        { n: "2.025", t: "It is form and content." },
        { n: "2.0251", t: "Space, time, and colour (being coloured) are forms of objects." },
        { n: "2.026", t: "There must be objects, if the world is to have an unalterable form." },
        { n: "2.027", t: "Objects, the unalterable, and the subsistent are one and the same." },
        { n: "2.0271", t: "Objects are what is unalterable and subsistent; their configuration is what is changing and unstable." },
        { n: "2.0272", t: "The configuration of objects produces states of affairs." },
        { n: "2.03", t: "In a state of affairs objects fit into one another like the links of a chain." },
        { n: "2.031", t: "In a state of affairs objects stand in a determinate relation to one another." },
        { n: "2.032", t: "The determinate way in which objects are connected in a state of affairs is the structure of the state of affairs." },
        { n: "2.033", t: "Form is the possibility of structure." },
        { n: "2.034", t: "The structure of a fact consists of the structures of states of affairs." },
        { n: "2.04", t: "The totality of existing states of affairs is the world." },
        { n: "2.05", t: "The totality of existing states of affairs also determines which states of affairs do not exist." },
        { n: "2.06", t: "The existence and non-existence of states of affairs is reality." },
        { n: "2.061", t: "States of affairs are independent of one another." },
        { n: "2.062", t: "From the existence or non-existence of one state of affairs it is impossible to infer the existence or non-existence of another." },
        { n: "2.063", t: "The sum-total of reality is the world." },
        { n: "2.1", t: "We picture facts to ourselves." },
        { n: "2.11", t: "A picture presents a situation in logical space, the existence and non-existence of states of affairs." },
        { n: "2.12", t: "A picture is a model of reality." },
        { n: "2.13", t: "In a picture objects have the elements of the picture corresponding to them." },
        { n: "2.131", t: "In a picture the elements of the picture are the representatives of objects." },
        { n: "2.14", t: "What constitutes a picture is that its elements are related to one another in a determinate way." },
        { n: "2.141", t: "A picture is a fact." },
        { n: "2.15", t: "The fact that the elements of a picture are related to one another in a determinate way represents that things are related to one another in the same way." },
        { n: "2.151", t: "Pictorial form is the possibility that things are related to one another in the same way as the elements of the picture." },
        { n: "2.1511", t: "That is how a picture is attached to reality; it reaches right out to it." },
        { n: "2.1512", t: "It is laid against reality like a measure." },
        { n: "2.15121", t: "Only the end-points of the graduating lines actually touch the object that is to be measured." },
        { n: "2.1513", t: "So a picture, conceived in this way, also includes the pictorial relationship, which makes it into a picture." },
        { n: "2.1514", t: "The pictorial relationship consists of the correlations of the picture's elements with things." },
        { n: "2.1515", t: "These correlations are, as it were, the feelers of the picture's elements, with which the picture touches reality." },
        { n: "2.16", t: "If a fact is to be a picture, it must have something in common with what it depicts." },
        { n: "2.161", t: "There must be something identical in a picture and what it depicts, to enable the one to be a picture of the other at all." },
        { n: "2.17", t: "What a picture must have in common with reality, in order to be able to depict it—correctly or incorrectly—in the way it does, is its pictorial form." },
        { n: "2.171", t: "A picture can depict any reality whose form it has." },
        { n: "2.172", t: "A picture cannot, however, depict its pictorial form: it displays it." },
        { n: "2.173", t: "A picture represents its subject from a position outside it. (Its standpoint is its representational form.)" },
        { n: "2.174", t: "A picture cannot, however, place itself outside its representational form." },
        { n: "2.18", t: "What any picture, of whatever form, must have in common with reality, in order to be able to depict it—correctly or incorrectly—in any way at all, is logical form, i.e. the form of reality." },
        { n: "2.181", t: "A picture whose pictorial form is logical form is called a logical picture." },
        { n: "2.182", t: "Every picture is at the same time a logical one. (On the other hand, not every picture is, for example, a spatial one.)" },
        { n: "2.19", t: "Logical pictures can depict the world." },
        { n: "2.2", t: "A picture has logico-pictorial form in common with what it depicts." },
        { n: "2.201", t: "A picture depicts reality by representing a possibility of existence and non-existence of states of affairs." },
        { n: "2.202", t: "A picture represents a possible situation in logical space." },
        { n: "2.203", t: "A picture contains the possibility of the situation that it represents." },
        { n: "2.21", t: "A picture agrees with reality or fails to agree; it is correct or incorrect, true or false." },
        { n: "2.22", t: "What a picture represents it represents independently of its truth or falsity, by means of its pictorial form." },
        { n: "2.221", t: "What a picture represents is its sense." },
        { n: "2.222", t: "The agreement or disagreement of its sense with reality constitutes its truth or falsity." },
        { n: "2.223", t: "In order to tell whether a picture is true or false we must compare it with reality." },
        { n: "2.224", t: "It is impossible to tell from the picture alone whether it is true or false." },
        { n: "2.225", t: "There are no pictures that are true a priori." },
        { n: "3", t: "A logical picture of facts is a thought." },
        { n: "3.01", t: "The totality of true thoughts is a picture of the world." },
        { n: "3.02", t: "A thought contains the possibility of the situation of which it is the thought. What is thinkable is possible too." },
        { n: "3.03", t: "Thought can never be of anything illogical, since, if it were, we should have to think illogically." },
        { n: "3.031", t: "It used to be said that God could create anything except what would be contrary to the laws of logic. The truth is that we could not say what an 'illogical' world would look like." },
        { n: "3.032", t: "It is as impossible to represent in language anything that 'contradicts logic' as it is in geometry to represent by its coordinates a figure that contradicts the laws of space." },
        { n: "3.04", t: "If a thought were correct a priori, it would be a thought whose possibility ensured its truth." },
        { n: "3.05", t: "A priori knowledge that a thought was true would be possible only if its truth were recognizable from the thought itself (without anything to compare it with)." },
        { n: "4", t: "A thought is a proposition with a sense." },
        { n: "4.001", t: "The totality of propositions is language." },
        { n: "4.002", t: "Man possesses the ability to construct languages capable of expressing every sense, without having any idea how each word has meaning or what its meaning is." },
        { n: "4.003", t: "Most of the propositions and questions to be found in philosophical works are not false but nonsensical." },
        { n: "4.01", t: "A proposition is a picture of reality." },
        { n: "4.011", t: "At first sight a proposition—one set out on the printed page, for example—does not seem to be a picture of the reality with which it is concerned." },
        { n: "4.012", t: "It is obvious that a proposition of the form 'aRb' strikes us as a picture. In this case the sign is obviously a likeness of what is signified." },
        { n: "4.02", t: "We can see this from the fact that we understand the sense of a propositional sign without its having been explained to us." },
        { n: "4.021", t: "A proposition is a picture of reality: for if I understand a proposition, I know the situation that it represents." },
        { n: "4.022", t: "A proposition shows its sense." },
        { n: "4.023", t: "A proposition must restrict reality to two alternatives: yes or no." },
        { n: "4.024", t: "To understand a proposition means to know what is the case if it is true." },
        { n: "4.025", t: "When translating one language into another, we do not proceed by translating each proposition of the one into a proposition of the other." },
        { n: "4.026", t: "The meanings of simple signs (words) must be explained to us if we are to understand them." },
        { n: "4.027", t: "It belongs to the essence of a proposition that it should be able to communicate a new sense to us." },
        { n: "5", t: "A proposition is a truth-function of elementary propositions." },
        { n: "5.1", t: "Truth-functions can be arranged in series." },
        { n: "5.2", t: "The structures of propositions stand in internal relations to one another." },
        { n: "5.3", t: "All propositions are results of truth-operations on elementary propositions." },
        { n: "5.4", t: "At this point it becomes manifest that there are no 'logical objects' or 'logical constants' (in Frege's and Russell's sense)." },
        { n: "5.5", t: "Every truth-function is a result of successive applications of the operation to elementary propositions." },
        { n: "5.6", t: "The limits of my language mean the limits of my world." },
        { n: "5.61", t: "Logic pervades the world: the limits of the world are also its limits." },
        { n: "5.62", t: "This remark provides the key to the problem, how much truth there is in solipsism." },
        { n: "5.621", t: "The world and life are one." },
        { n: "5.63", t: "I am my world. (The microcosm.)" },
        { n: "5.631", t: "There is no such thing as the subject that thinks or entertains ideas." },
        { n: "5.632", t: "The subject does not belong to the world: rather, it is a limit of the world." },
        { n: "5.633", t: "Where in the world is a metaphysical subject to be found?" },
        { n: "5.634", t: "Whatever we see could be other than it is." },
        { n: "5.64", t: "Here it can be seen that solipsism, when its implications are followed out strictly, coincides with pure realism. The self of solipsism shrinks to a point without extension, and there remains the reality co-ordinated with it." },
        { n: "6", t: "The general form of a truth-function is: this is the general form of a proposition." },
        { n: "6.1", t: "The propositions of logic are tautologies." },
        { n: "6.11", t: "Therefore the propositions of logic say nothing. (They are the analytic propositions.)" },
        { n: "6.12", t: "The fact that the propositions of logic are tautologies shows the formal—logical—properties of language and the world." },
        { n: "6.13", t: "Logic is not a body of doctrine, but a mirror-image of the world." },
        { n: "6.2", t: "Mathematics is a logical method." },
        { n: "6.21", t: "A proposition of mathematics does not express a thought." },
        { n: "6.22", t: "The logic of the world, which is shown in tautologies by the propositions of logic, is shown in equations by mathematics." },
        { n: "6.3", t: "The exploration of logic means the exploration of everything that is subject to law." },
        { n: "6.31", t: "The so-called law of induction cannot possibly be a law of logic, since it is obviously a proposition with sense." },
        { n: "6.32", t: "The law of causality is not a law but the form of a law." },
        { n: "6.33", t: "We do not have an a priori belief in a law of conservation." },
        { n: "6.34", t: "All such propositions, including the principle of sufficient reason, the laws of continuity and of least effort in nature, etc.—all these are a priori insights about the forms in which the propositions of science can be cast." },
        { n: "6.35", t: "Although the spots in our picture are geometrical figures, nevertheless geometry can obviously say nothing at all about their actual form and position." },
        { n: "6.36", t: "If there were a law of causality, it might be put in the following way: There are laws of nature." },
        { n: "6.361", t: "One might say, using Hertz's terminology, that only connexions that are subject to law are thinkable." },
        { n: "6.362", t: "What can be described can happen too: and what the law of causality is meant to exclude cannot even be described." },
        { n: "6.363", t: "The procedure of induction consists in accepting as true the simplest law that can be reconciled with our experiences." },
        { n: "6.37", t: "There is no compulsion making one thing happen because another has happened. The only necessity that exists is logical necessity." },
        { n: "6.371", t: "The whole modern conception of the world is founded on the illusion that the so-called laws of nature are the explanations of natural phenomena." },
        { n: "6.372", t: "Thus people today stop at the laws of nature, treating them as something inviolable, just as God and Fate were treated in past ages." },
        { n: "6.373", t: "The world is independent of my will." },
        { n: "6.374", t: "Even if all that we wish for were to happen, still this would only be a favour granted by fate, so to speak." },
        { n: "6.375", t: "Just as the only necessity that exists is logical necessity, so too the only impossibility that exists is logical impossibility." },
        { n: "6.4", t: "All propositions are of equal value." },
        { n: "6.41", t: "The sense of the world must lie outside the world." },
        { n: "6.42", t: "So too it is impossible for there to be propositions of ethics." },
        { n: "6.421", t: "It is clear that ethics cannot be put into words." },
        { n: "6.422", t: "When an ethical law of the form, 'Thou shalt...' is laid down, one's first thought is, 'And what if I do not do it?'" },
        { n: "6.423", t: "It is impossible to speak about the will in so far as it is the subject of ethical attributes." },
        { n: "6.43", t: "If the good or bad exercise of the will does alter the world, it can alter only the limits of the world, not the facts." },
        { n: "6.431", t: "So too at death the world does not alter, but comes to an end." },
        { n: "6.4311", t: "Death is not an event in life: we do not live to experience death." },
        { n: "6.4312", t: "Not only is there no guarantee of the temporal immortality of the human soul, but this assumption completely fails to accomplish the purpose for which it has always been intended." },
        { n: "6.432", t: "How things are in the world is a matter of complete indifference for what is higher. God does not reveal himself in the world." },
        { n: "6.44", t: "It is not how things are in the world that is mystical, but that it exists." },
        { n: "6.45", t: "To view the world sub specie aeterni is to view it as a whole—a limited whole." },
        { n: "6.5", t: "When the answer cannot be put into words, neither can the question be put into words." },
        { n: "6.51", t: "Scepticism is not irrefutable, but obviously nonsensical, when it tries to raise doubts where no questions can be asked." },
        { n: "6.52", t: "We feel that even when all possible scientific questions have been answered, the problems of life remain completely untouched." },
        { n: "6.521", t: "The solution of the problem of life is seen in the vanishing of the problem." },
        { n: "6.522", t: "There are, indeed, things that cannot be put into words. They make themselves manifest. They are what is mystical." },
        { n: "6.53", t: "The correct method in philosophy would really be the following: to say nothing except what can be said, and then, whenever someone else wanted to say something metaphysical, to demonstrate to him that he had failed to give a meaning to certain signs in his propositions." },
        { n: "6.54", t: "My propositions serve as elucidations in the following way: anyone who understands me eventually recognizes them as nonsensical, when he has used them—as steps—to climb up beyond them. (He must, so to speak, throw away the ladder after he has climbed up it.)" },
        { n: "7", t: "What we cannot speak about we must pass over in silence." }
    ];

    // ═══════════════════════════════════════════════════════════════════════════
    // REALMS - Extended corpuses for other levels
    // ═══════════════════════════════════════════════════════════════════════════

    const REALMS = [
        {
            name: "I. Tractatus",
            subtitle: "The limits of language are the limits of the world",
            keyItem: "ladder",
            items: ["picture", "fact", "proposition"],
            mechanic: "tractatus",
            mechanicHint: "Each step reveals a new proposition. Progress through the numbered sequence."
        },
        {
            name: "II. Hexagrams",
            subtitle: "The Changes have no consciousness, no action; still and unmoving",
            keyItem: "yarrow",
            items: ["coins", "tortoise", "dragon"],
            mechanic: "divination",
            mechanicHint: "Cast the coins before each step. The oracle guides your path.",
            corpus: [
                "The Creative works sublime success, furthering through perseverance. The movement of heaven is full of power. Thus the superior man makes himself strong and untiring. The dragon appears in the field. It furthers one to see the great man.",
                "The Receptive brings about sublime success, furthering through the perseverance of a mare. If the superior man undertakes something and tries to lead, he goes astray; but if he follows, he finds guidance.",
                "Difficulty at the Beginning works supreme success, furthering through perseverance. Clouds and thunder: the image of Difficulty at the Beginning. Thus the superior man brings order out of confusion.",
                "Youthful Folly has success. It is not I who seek the young fool; the young fool seeks me. At the first oracle I inform him. A spring wells up at the foot of the mountain, the image of youth.",
                "Waiting with sincerity brings light and success. Perseverance brings good fortune. It furthers one to cross the great water. Clouds rise up to heaven: the image of Waiting.",
                "Conflict: You are sincere and are being obstructed. A cautious halt halfway brings good fortune. Heaven and water go their opposite ways: the image of Conflict.",
                "The Army needs perseverance and a strong man. In the middle of the earth is water: the image of the Army. Thus the superior man increases his masses by generosity toward the people.",
                "Holding Together brings good fortune. On the earth is water: the image of Holding Together. Thus the kings of antiquity bestowed the different states as fiefs."
            ]
        },
        {
            name: "III. Hermetic",
            subtitle: "As above, so below; as within, so without",
            keyItem: "philosopher-stone",
            items: ["mercury", "sulfur", "salt"],
            mechanic: "transmutation",
            mechanicHint: "Three principles unite: sulfur (soul), mercury (spirit), salt (body). Gather all three.",
            corpus: [
                "True, without falsehood, certain and most true: what is above is like what is below, and what is below is like what is above, to accomplish the miracle of the One Thing.",
                "The Sun is its father, the Moon its mother. The Wind carried it in its belly, the Earth is its nurse. The father of all perfection in the whole world is here.",
                "It ascends from earth to heaven, and again it descends to earth, and receives the power of the superiors and the inferiors. Thus you will have the glory of the whole world.",
                "Therefore I am called Hermes Trismegistus, having three parts of the wisdom of the whole world. What I have to say about the operation of Sol is completed.",
                "Know then the greatest secret of the universe: that which is above is from that which is below, working the miracles of one thing.",
                "This thing is the strong fortitude of all fortitude, because it overcomes every subtle thing and penetrates every solid. Thus was the world created.",
                "Combine the volatile with the fixed. Unite the masculine with the feminine. Marry the king to the queen. Through putrefaction comes generation.",
                "The stone which the builders rejected has become the cornerstone. In stercore invenitur—in filth it shall be found. That which is most common is most precious."
            ]
        },
        {
            name: "IV. Library",
            subtitle: "The universe, which others call the Library",
            keyItem: "crimson-hexagon",
            items: ["book", "mirror", "lamp"],
            mechanic: "infinite",
            mechanicHint: "The Library is infinite and periodic. Walking far enough returns you to the beginning.",
            corpus: [
                "The universe, which others call the Library, is composed of an indefinite, perhaps infinite number of hexagonal galleries.",
                "The arrangement of the galleries is always the same: Twenty bookshelves, five to each side, line four of the hexagon's six sides.",
                "Each book is four hundred ten pages; each page, forty lines, each line, approximately eighty black letters.",
                "The Library is total—perfect, complete, whole. Its bookshelves contain all possible combinations of the twenty-two orthographic symbols.",
                "When it was announced that the Library contained all books, the first reaction was unbounded joy.",
                "As was foreseeable, that unbounded hope was followed by a similarly unbounded despair.",
                "I know of districts in which the young prostrate themselves before books and like savages kiss their pages, though they cannot read a single letter.",
                "The Library will endure: illuminated, solitary, infinite, perfectly still, armed with precious volumes, pointless, incorruptible, secret."
            ]
        },
        {
            name: "V. Koans",
            subtitle: "What is the sound of one hand clapping?",
            keyItem: "mu",
            items: ["bowl", "staff", "bell"],
            mechanic: "paradox",
            mechanicHint: "The key appears only to those who have stopped seeking it.",
            corpus: [
                "A monk asked Zhaozhou, 'Does a dog have Buddha nature or not?' Zhaozhou replied, 'Mu.'",
                "What is the sound of one hand clapping? If you say something, you miss it entirely. If you remain silent, you miss it equally.",
                "Before your father and mother were born, what was your original face?",
                "If you meet the Buddha on the road, kill him. The treasure house is within you—everything you need is already there.",
                "Sitting quietly, doing nothing, spring comes, and the grass grows by itself.",
                "The cypress tree in the garden—this is the answer to all your questions. But what does it mean?",
                "When you can do nothing, what can you do? When you have nowhere to go, where will you go?",
                "To study the self is to forget the self. To forget the self is to be enlightened by all things."
            ]
        },
        {
            name: "VI. Dissolve",
            subtitle: "...",
            keyItem: null,
            items: [],
            mechanic: "void",
            mechanicHint: "",
            corpus: ["", "", "", "", "", "", "", ""]
        }
    ];

    // ═══════════════════════════════════════════════════════════════════════════
    // STATE
    // ═══════════════════════════════════════════════════════════════════════════

    let level = 0;
    let maze = [];
    let player = { x: 0, y: 0 };
    let items = [];
    let inventory = [];
    let rooms = {};
    let stairsPos = null;
    let seekingKey = true;
    let moveCount = 0;
    let propositionIndex = 0; // For Tractatus progression

    const SIZES = [17, 19, 21, 23, 19, 15];
    const CELL_SIZE = 20;

    // Canvas elements
    let canvas, ctx;

    // ═══════════════════════════════════════════════════════════════════════════
    // BIGRAM MARKOV CHAIN
    // ═══════════════════════════════════════════════════════════════════════════

    function buildMarkov(texts) {
        const chain = {};
        const starters = [];

        for (const text of texts) {
            const words = text.split(/\s+/).filter(w => w);
            if (words.length < 3) continue;
            starters.push(words[0] + ' ' + words[1]);

            for (let i = 0; i < words.length - 2; i++) {
                const key = words[i] + ' ' + words[i + 1];
                if (!chain[key]) chain[key] = [];
                chain[key].push(words[i + 2]);
            }
        }

        return { chain, starters };
    }

    function generate(markov, minWords = 20, maxWords = 35) {
        const { chain, starters } = markov;
        if (starters.length === 0) return "...";

        let current = starters[Math.floor(Math.random() * starters.length)];
        let result = current.split(' ');
        let targetLength = minWords + Math.floor(Math.random() * (maxWords - minWords));

        for (let i = 0; i < targetLength; i++) {
            const next = chain[current];
            if (!next || next.length === 0) {
                current = starters[Math.floor(Math.random() * starters.length)];
                const words = current.split(' ');
                result.push('—', words[0], words[1]);
            } else {
                const word = next[Math.floor(Math.random() * next.length)];
                result.push(word);
                const parts = current.split(' ');
                current = parts[1] + ' ' + word;
            }
        }

        let text = result.join(' ');
        const lastPeriod = Math.max(text.lastIndexOf('.'), text.lastIndexOf('?'), text.lastIndexOf('!'));
        if (lastPeriod > text.length * 0.5) text = text.slice(0, lastPeriod + 1);
        else if (!text.endsWith('.')) text += '.';

        return text;
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // MAZE GENERATION - Kruskal's algorithm
    // ═══════════════════════════════════════════════════════════════════════════

    function generateMaze(W, H) {
        const grid = Array(H).fill(null).map(() => Array(W).fill('#'));
        const cells = [];

        for (let y = 1; y < H - 1; y += 2) {
            for (let x = 1; x < W - 1; x += 2) {
                grid[y][x] = '.';
                cells.push({ x, y, set: cells.length });
            }
        }

        const walls = [];
        for (let y = 1; y < H - 1; y += 2) {
            for (let x = 1; x < W - 1; x += 2) {
                if (x + 2 < W - 1) walls.push({ x1: x, y1: y, x2: x + 2, y2: y, wx: x + 1, wy: y });
                if (y + 2 < H - 1) walls.push({ x1: x, y1: y, x2: x, y2: y + 2, wx: x, wy: y + 1 });
            }
        }

        for (let i = walls.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [walls[i], walls[j]] = [walls[j], walls[i]];
        }

        function findCell(x, y) { return cells.find(c => c.x === x && c.y === y); }
        function findSet(cell) {
            if (cell.set !== cells.indexOf(cell)) {
                const parent = cells[cell.set];
                cell.set = findSet(parent);
            }
            return cell.set;
        }
        function union(cell1, cell2) {
            const set1 = findSet(cell1), set2 = findSet(cell2);
            if (set1 !== set2) { cells[set1].set = set2; return true; }
            return false;
        }

        for (const wall of walls) {
            const cell1 = findCell(wall.x1, wall.y1);
            const cell2 = findCell(wall.x2, wall.y2);
            if (union(cell1, cell2)) grid[wall.wy][wall.wx] = '.';
        }

        // Add some loops
        const extraWalls = walls.filter(w => grid[w.wy][w.wx] === '#');
        const extraCount = Math.floor(extraWalls.length * 0.12);
        for (let i = 0; i < extraCount && i < extraWalls.length; i++) {
            const w = extraWalls[Math.floor(Math.random() * extraWalls.length)];
            grid[w.wy][w.wx] = '.';
        }

        return grid;
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // LEVEL INITIALIZATION
    // ═══════════════════════════════════════════════════════════════════════════

    function initLevel() {
        const realm = REALMS[level];
        const W = SIZES[level];
        const H = SIZES[level];

        document.body.className = `level-${level}`;
        document.getElementById('level-name').textContent = realm.name;
        document.getElementById('level-subtitle').textContent = realm.subtitle;
        document.getElementById('depth').textContent = `stratum ${['I', 'II', 'III', 'IV', 'V', 'VI'][level]}`;

        const hintEl = document.getElementById('mechanic-hint');
        if (realm.mechanicHint) {
            hintEl.textContent = realm.mechanicHint;
            hintEl.style.display = 'block';
        } else {
            hintEl.style.display = 'none';
        }

        // Build markov for non-Tractatus levels
        const markov = realm.corpus ? buildMarkov(realm.corpus) : null;

        maze = generateMaze(W, H);

        // Setup canvas
        canvas = document.getElementById('maze-canvas');
        canvas.width = W * CELL_SIZE;
        canvas.height = H * CELL_SIZE;
        ctx = canvas.getContext('2d');

        const floors = [];
        for (let y = 1; y < H - 1; y++) {
            for (let x = 1; x < W - 1; x++) {
                if (maze[y][x] === '.') floors.push({ x, y });
            }
        }

        for (let i = floors.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [floors[i], floors[j]] = [floors[j], floors[i]];
        }

        const startCandidates = floors.filter(f => f.x < W / 3 && f.y < H / 3);
        const start = startCandidates.length > 0 ? startCandidates[0] : floors[0];
        player = { x: start.x, y: start.y };

        items = [];
        let floorIdx = 0;
        const allItems = [...realm.items];
        if (realm.keyItem) allItems.push(realm.keyItem);

        for (const itemName of allItems) {
            while (floorIdx < floors.length) {
                const f = floors[floorIdx++];
                if (f.x !== player.x || f.y !== player.y) {
                    items.push({
                        x: f.x, y: f.y, name: itemName,
                        isKey: itemName === realm.keyItem,
                        visible: realm.mechanic !== 'paradox' || itemName !== realm.keyItem
                    });
                    break;
                }
            }
        }

        if (level < REALMS.length - 1) {
            const farFloors = floors
                .filter(f => f.x !== player.x || f.y !== player.y)
                .filter(f => !items.some(i => i.x === f.x && i.y === f.y))
                .sort((a, b) => {
                    const da = Math.abs(a.x - player.x) + Math.abs(a.y - player.y);
                    const db = Math.abs(b.x - player.x) + Math.abs(b.y - player.y);
                    return db - da;
                });
            stairsPos = farFloors[0] || floors[floors.length - 1];
        } else {
            stairsPos = null;
        }

        rooms = {};
        for (let i = 0; i < floors.length; i++) {
            const f = floors[i];
            if (level === 0) {
                // Tractatus: assign propositions in order of room visitation
                rooms[`${f.x},${f.y}`] = i;
            } else {
                rooms[`${f.x},${f.y}`] = markov ? generate(markov, 18, 30) : '...';
            }
        }

        seekingKey = true;
        moveCount = 0;
        propositionIndex = 0;
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // LEVEL-SPECIFIC MECHANICS
    // ═══════════════════════════════════════════════════════════════════════════

    function applyMechanic(dir) {
        const realm = REALMS[level];
        switch (realm.mechanic) {
            case 'tractatus': return tractatusMove(dir);
            case 'divination': return divinationMove(dir);
            case 'infinite': return infiniteMove(dir);
            case 'paradox': return paradoxMove(dir);
            case 'void': return voidMove(dir);
            default: return { dir, message: null };
        }
    }

    function tractatusMove(dir) {
        // In Tractatus, each move advances through propositions
        if (propositionIndex < TRACTATUS.length - 1) {
            propositionIndex++;
        }
        return { dir, message: null };
    }

    function divinationMove(dir) {
        const coins = [Math.random() > 0.5, Math.random() > 0.5, Math.random() > 0.5];
        const value = coins.filter(c => c).length;
        const divEl = document.getElementById('divination');
        const hexagram = coins.map(c => c ? '⚊' : '⚋').join(' ');
        const directions = ['n', 'e', 's', 'w'];

        if (value === 0 || value === 3) {
            const newDir = directions[(directions.indexOf(dir) + (value === 3 ? 1 : 3)) % 4];
            divEl.innerHTML = `<h3>The Oracle Speaks</h3><div class="hexagram">${hexagram}</div><p>The way shifts ${value === 3 ? 'rightward' : 'leftward'}.</p>`;
            divEl.style.display = 'block';
            setTimeout(() => { divEl.style.display = 'none'; }, 1200);
            return { dir: newDir, message: null };
        } else {
            divEl.innerHTML = `<h3>The Oracle Speaks</h3><div class="hexagram">${hexagram}</div><p>The path is clear.</p>`;
            divEl.style.display = 'block';
            setTimeout(() => { divEl.style.display = 'none'; }, 800);
            return { dir, message: null };
        }
    }

    function infiniteMove(dir) {
        const W = SIZES[level], H = SIZES[level];
        const dirs = { n: [0, -1], s: [0, 1], w: [-1, 0], e: [1, 0] };
        const [dx, dy] = dirs[dir];
        let nx = player.x + dx, ny = player.y + dy;

        if (nx < 1) nx = W - 2;
        if (nx > W - 2) nx = 1;
        if (ny < 1) ny = H - 2;
        if (ny > H - 2) ny = 1;

        if (maze[ny][nx] === '#') {
            for (let r = 1; r < W; r++) {
                for (const [ddx, ddy] of [[0,0], [1,0], [-1,0], [0,1], [0,-1]]) {
                    const tx = ((nx + ddx * r - 1 + W - 2) % (W - 2)) + 1;
                    const ty = ((ny + ddy * r - 1 + H - 2) % (H - 2)) + 1;
                    if (maze[ty][tx] === '.') {
                        player.x = tx; player.y = ty;
                        return { dir: null, message: "The corridors fold upon themselves." };
                    }
                }
            }
        }
        player.x = nx; player.y = ny;
        return { dir: null, message: null };
    }

    function paradoxMove(dir) {
        moveCount++;
        const keyItem = items.find(i => i.isKey);
        if (keyItem && !keyItem.visible) {
            const dist = Math.abs(keyItem.x - player.x) + Math.abs(keyItem.y - player.y);
            if (moveCount > 15 && dist > 5) {
                keyItem.visible = true;
                return { dir, message: "You've stopped seeking. Something appears." };
            }
        }
        return { dir, message: null };
    }

    function voidMove(dir) {
        if (Math.random() < 0.3) {
            const directions = ['n', 'e', 's', 'w'];
            return { dir: directions[Math.floor(Math.random() * 4)], message: null };
        }
        const dirs = { n: [0, -1], s: [0, 1], w: [-1, 0], e: [1, 0] };
        const [dx, dy] = dirs[dir];
        const nx = player.x + dx, ny = player.y + dy;
        if (maze[ny] && maze[ny][nx] === '#' && Math.random() < 0.2) {
            player.x = nx; player.y = ny;
            return { dir: null, message: null };
        }
        return { dir, message: null };
    }

    function checkTransmutation() {
        if (level !== 2) return null;
        const hasSulfur = inventory.includes('sulfur');
        const hasMercury = inventory.includes('mercury');
        const hasSalt = inventory.includes('salt');

        if (hasSulfur && hasMercury && hasSalt && !inventory.includes('philosopher-stone')) {
            inventory = inventory.filter(i => i !== 'sulfur' && i !== 'mercury' && i !== 'salt');
            inventory.push('philosopher-stone');
            return "The three principles unite! The philosopher's stone emerges.";
        }
        return null;
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // GRAPHICAL RENDERING
    // ═══════════════════════════════════════════════════════════════════════════

    function render() {
        const realm = REALMS[level];
        const W = SIZES[level], H = SIZES[level];
        const hasKey = realm.keyItem ? inventory.includes(realm.keyItem) : false;

        // Get computed colors
        const style = getComputedStyle(document.body);
        const wallColor = style.getPropertyValue('--wall').trim() || '#1a1a1e';
        const floorColor = style.getPropertyValue('--floor').trim() || '#0d0d10';
        const accentColor = style.getPropertyValue('--accent').trim() || '#10b981';
        const accentBright = style.getPropertyValue('--accent-bright').trim() || '#34d399';

        // Clear canvas
        ctx.fillStyle = floorColor;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw maze with rounded walls
        ctx.fillStyle = wallColor;
        for (let y = 0; y < H; y++) {
            for (let x = 0; x < W; x++) {
                if (maze[y] && maze[y][x] === '#') {
                    const px = x * CELL_SIZE;
                    const py = y * CELL_SIZE;
                    const r = 3; // corner radius

                    // Check neighbors for rounded corners
                    const top = y > 0 && maze[y-1][x] === '#';
                    const bot = y < H-1 && maze[y+1][x] === '#';
                    const left = x > 0 && maze[y][x-1] === '#';
                    const right = x < W-1 && maze[y][x+1] === '#';

                    ctx.beginPath();
                    ctx.roundRect(px + 1, py + 1, CELL_SIZE - 2, CELL_SIZE - 2, [
                        (!top && !left) ? r : 0,
                        (!top && !right) ? r : 0,
                        (!bot && !right) ? r : 0,
                        (!bot && !left) ? r : 0
                    ]);
                    ctx.fill();
                }
            }
        }

        // Draw subtle grid on floor
        ctx.strokeStyle = 'rgba(255,255,255,0.02)';
        ctx.lineWidth = 1;
        for (let y = 0; y < H; y++) {
            for (let x = 0; x < W; x++) {
                if (maze[y] && maze[y][x] === '.') {
                    ctx.strokeRect(x * CELL_SIZE + 2, y * CELL_SIZE + 2, CELL_SIZE - 4, CELL_SIZE - 4);
                }
            }
        }

        // Draw stairs (if key found)
        if (stairsPos && hasKey) {
            const sx = stairsPos.x * CELL_SIZE + CELL_SIZE / 2;
            const sy = stairsPos.y * CELL_SIZE + CELL_SIZE / 2;
            ctx.fillStyle = '#eab308';
            ctx.beginPath();
            ctx.moveTo(sx, sy + 6);
            ctx.lineTo(sx - 6, sy - 4);
            ctx.lineTo(sx + 6, sy - 4);
            ctx.closePath();
            ctx.fill();
        }

        // Draw items
        for (const item of items) {
            if (!item.visible) continue;
            const ix = item.x * CELL_SIZE + CELL_SIZE / 2;
            const iy = item.y * CELL_SIZE + CELL_SIZE / 2;

            if (item.isKey) {
                ctx.fillStyle = accentColor;
                ctx.beginPath();
                // Diamond shape for key items
                ctx.moveTo(ix, iy - 6);
                ctx.lineTo(ix + 5, iy);
                ctx.lineTo(ix, iy + 6);
                ctx.lineTo(ix - 5, iy);
                ctx.closePath();
                ctx.fill();
            } else {
                ctx.fillStyle = '#3b82f6';
                ctx.beginPath();
                ctx.arc(ix, iy, 4, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Draw player with glow
        const px = player.x * CELL_SIZE + CELL_SIZE / 2;
        const py = player.y * CELL_SIZE + CELL_SIZE / 2;

        // Glow
        const gradient = ctx.createRadialGradient(px, py, 0, px, py, 14);
        gradient.addColorStop(0, accentBright + '40');
        gradient.addColorStop(1, 'transparent');
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(px, py, 14, 0, Math.PI * 2);
        ctx.fill();

        // Player circle
        ctx.fillStyle = accentBright;
        ctx.beginPath();
        ctx.arc(px, py, 6, 0, Math.PI * 2);
        ctx.fill();

        // Proposition display (Tractatus level)
        const propEl = document.getElementById('proposition');
        if (level === 0 && propositionIndex < TRACTATUS.length) {
            const prop = TRACTATUS[propositionIndex];
            propEl.innerHTML = `<span class="number">${prop.n}</span>${prop.t}`;
            propEl.style.display = 'block';
        } else {
            propEl.style.display = 'none';
        }

        // Description
        const roomKey = `${player.x},${player.y}`;
        let desc;
        if (level === 0) {
            // For Tractatus, show the current proposition as main text
            const prop = TRACTATUS[propositionIndex];
            desc = prop ? prop.t : '...';
        } else {
            desc = typeof rooms[roomKey] === 'string' ? rooms[roomKey] : '...';
        }

        const here = items.filter(i => i.x === player.x && i.y === player.y && (i.visible !== false));
        if (here.length) {
            desc += `\n\nHere lies: ${here.map(i => i.isKey ? `◆ ${i.name}` : i.name).join(', ')}.`;
        }

        if (stairsPos && player.x === stairsPos.x && player.y === stairsPos.y) {
            if (hasKey) desc += '\n\nStairs spiral downward into deeper darkness.';
            else if (realm.keyItem) desc += `\n\nA sealed passage. It awaits the ${realm.keyItem}.`;
        }

        document.getElementById('description').textContent = desc;
        document.getElementById('inv').textContent = inventory.length ? inventory.join(', ') : 'nothing';

        // Hint
        const hint = document.getElementById('hint');
        if (level === 0) {
            hint.textContent = `proposition ${propositionIndex + 1} of ${TRACTATUS.length}`;
        } else if (level === 2) {
            const hasStone = inventory.includes('philosopher-stone');
            if (!hasStone) {
                const has = [
                    inventory.includes('sulfur') ? 'sulfur' : null,
                    inventory.includes('mercury') ? 'mercury' : null,
                    inventory.includes('salt') ? 'salt' : null
                ].filter(Boolean);
                hint.textContent = has.length === 0 ? 'gather the three principles' : has.length < 3 ? `${has.join(' + ')} — seek the rest` : '';
            } else {
                hint.textContent = 'the stone is yours — find the way down';
            }
        } else if (!hasKey && realm.keyItem) {
            hint.textContent = `seek the ${realm.keyItem}`;
        } else if (hasKey && stairsPos) {
            hint.textContent = 'descend ▼';
        } else {
            hint.textContent = '';
        }

        // Buttons
        document.getElementById('btn-n').disabled = !canMove(0, -1);
        document.getElementById('btn-s').disabled = !canMove(0, 1);
        document.getElementById('btn-w').disabled = !canMove(-1, 0);
        document.getElementById('btn-e').disabled = !canMove(1, 0);

        const btnDescend = document.getElementById('btn-descend');
        const canDescendNow = stairsPos && player.x === stairsPos.x && player.y === stairsPos.y && hasKey;
        btnDescend.style.display = canDescendNow ? 'inline-block' : 'none';
    }

    function canMove(dx, dy) {
        const realm = REALMS[level];
        const W = SIZES[level], H = SIZES[level];
        const nx = player.x + dx, ny = player.y + dy;

        if (realm.mechanic === 'infinite') return true;
        if (realm.mechanic === 'void') return true;

        return nx >= 0 && nx < W && ny >= 0 && ny < H && maze[ny] && maze[ny][nx] !== '#';
    }

    function move(dir) {
        const result = applyMechanic(dir);

        if (result.dir !== null) {
            const dirs = { n: [0, -1], s: [0, 1], w: [-1, 0], e: [1, 0] };
            const [dx, dy] = dirs[result.dir];
            if (canMove(dx, dy)) {
                player.x += dx;
                player.y += dy;
            }
        }

        render();
    }

    function take() {
        const visibleItems = items.filter(i => i.x === player.x && i.y === player.y && (i.visible !== false));
        if (visibleItems.length > 0) {
            for (const item of visibleItems) {
                inventory.push(item.name);
                const idx = items.indexOf(item);
                if (idx >= 0) items.splice(idx, 1);
            }
            const transMsg = checkTransmutation();
            if (transMsg) alert(transMsg);
            render();
        }
    }

    function descend() {
        const realm = REALMS[level];
        const hasKey = realm.keyItem ? inventory.includes(realm.keyItem) : true;

        if (stairsPos && player.x === stairsPos.x && player.y === stairsPos.y && hasKey) {
            level++;
            inventory = [];
            initLevel();
            render();
        }
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // KEYBOARD CONTROLS
    // ═══════════════════════════════════════════════════════════════════════════

    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT') return;

        const map = {
            ArrowUp: 'n', ArrowDown: 's', ArrowLeft: 'w', ArrowRight: 'e',
            w: 'n', s: 's', a: 'w', d: 'e',
            k: 'n', j: 's', h: 'w', l: 'e'
        };

        if (map[e.key]) { e.preventDefault(); move(map[e.key]); }
        if (e.key === ' ' || e.key === 'Enter' || e.key === 'g') { e.preventDefault(); take(); }
        if (e.key === '>' || e.key === '.') { e.preventDefault(); descend(); }
    });

    // ═══════════════════════════════════════════════════════════════════════════
    // INITIALIZE
    // ═══════════════════════════════════════════════════════════════════════════

    initLevel();
    render();
    </script>
</body>
</html>
