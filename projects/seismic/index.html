<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seismic Activity — hyle</title>
    <meta name="description" content="Real-time earthquake visualization and sonification using USGS data">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>λ</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050506;
            --text: #f0f0f3;
            --text-secondary: #a0a0ab;
            --text-muted: #606068;
            --accent: #10b981;
            --accent-bright: #34d399;
            --border: #1a1a20;
            --blue: #3b82f6;
            --orange: #f97316;
            --red: #ef4444;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'SF Mono', Consolas, monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: var(--font-sans);
            overflow: hidden;
        }

        /* Nav */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            background: linear-gradient(to bottom, rgba(5,5,6,0.9), transparent);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text);
            text-decoration: none;
            font-weight: 600;
        }

        .brand .lambda { color: var(--accent); font-size: 1.25rem; }
        .brand:hover .lambda { color: var(--accent-bright); }

        .back-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.85rem;
            transition: color 0.2s;
        }

        .back-link:hover { color: var(--accent); }

        #map { position: fixed; top: 0; left: 0; width: 100%; height: 100%; }

        #ui {
            position: fixed;
            bottom: 1.5rem;
            left: 1.5rem;
            right: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: none;
            z-index: 10;
        }

        #info {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
        }

        #info a {
            color: var(--accent);
            pointer-events: auto;
            text-decoration: none;
        }

        #info a:hover { color: var(--accent-bright); }

        #controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        button {
            background: rgba(10, 10, 15, 0.8);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 0.6rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            pointer-events: auto;
            font-family: var(--font-sans);
            font-size: 0.9rem;
            font-weight: 500;
            backdrop-filter: blur(12px);
            transition: all 0.2s;
        }

        button:hover {
            border-color: var(--accent);
            background: rgba(16, 185, 129, 0.15);
        }

        button.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg);
        }

        #status {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
            pointer-events: auto;
        }

        #legend {
            position: fixed;
            top: 70px;
            right: 1.5rem;
            background: rgba(10, 10, 15, 0.85);
            border: 1px solid var(--border);
            padding: 1rem 1.25rem;
            border-radius: 12px;
            font-size: 0.8rem;
            backdrop-filter: blur(12px);
        }

        #legend strong {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent);
            font-weight: 500;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin: 0.4rem 0;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <nav>
        <a href="/" class="brand">
            <span class="lambda">λ</span>
            <span>hyle</span>
        </a>
        <a href="/projects/" class="back-link">← Projects</a>
    </nav>
    <canvas id="map"></canvas>
    <div id="ui">
        <div id="info">
            data: <a href="https://earthquake.usgs.gov">USGS</a>
        </div>
        <div id="controls">
            <span id="status">loading...</span>
            <button id="sound" onclick="toggleSound()">sound off</button>
        </div>
    </div>
    <div id="legend">
        <div><strong>magnitude → pitch</strong></div>
        <div class="legend-item"><span class="legend-dot" style="background:#10b981"></span> M &lt; 3</div>
        <div class="legend-item"><span class="legend-dot" style="background:#3b82f6"></span> M 3-5</div>
        <div class="legend-item"><span class="legend-dot" style="background:#f97316"></span> M 5-7</div>
        <div class="legend-item"><span class="legend-dot" style="background:#ef4444"></span> M &gt; 7</div>
    </div>

    <script>
        const canvas = document.getElementById('map');
        const ctx = canvas.getContext('2d');
        let earthquakes = [];
        let rings = [];
        let soundEnabled = false;
        let audioCtx = null;

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener('resize', resize);

        // Mercator projection
        function project(lat, lon) {
            const x = (lon + 180) / 360 * canvas.width;
            const latRad = lat * Math.PI / 180;
            const mercN = Math.log(Math.tan(Math.PI/4 + latRad/2));
            const y = canvas.height/2 - mercN * canvas.height / (2 * Math.PI);
            return { x, y };
        }

        // Magnitude to color (matching CSS variables)
        function magColor(mag) {
            if (mag < 3) return '#10b981';  // accent green
            if (mag < 5) return '#3b82f6';  // blue
            if (mag < 7) return '#f97316';  // orange
            return '#ef4444';  // red
        }

        // Magnitude to frequency (Hz)
        function magFreq(mag) {
            return 80 + (mag / 10) * 720; // 80Hz to 800Hz
        }

        // Depth to reverb (not actual reverb, just duration)
        function depthDuration(depth) {
            return 0.1 + (depth / 700) * 2.9; // 0.1s to 3s
        }

        // Play sound for earthquake
        function playQuake(eq) {
            if (!soundEnabled || !audioCtx) return;

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.type = 'sine';
            osc.frequency.value = magFreq(eq.mag);

            // Stereo pan based on longitude
            const pan = audioCtx.createStereoPanner();
            pan.pan.value = (eq.lon / 180); // -1 to 1

            const duration = depthDuration(eq.depth);
            const now = audioCtx.currentTime;

            gain.gain.setValueAtTime(0.3, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + duration);

            osc.connect(gain);
            gain.connect(pan);
            pan.connect(audioCtx.destination);

            osc.start(now);
            osc.stop(now + duration);
        }

        function toggleSound() {
            const btn = document.getElementById('sound');
            soundEnabled = !soundEnabled;
            btn.textContent = soundEnabled ? 'sound on' : 'sound off';
            btn.classList.toggle('active', soundEnabled);

            if (soundEnabled && !audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // Fetch earthquakes from USGS
        async function fetchQuakes() {
            try {
                const res = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson');
                const data = await res.json();
                const newQuakes = data.features.map(f => ({
                    id: f.id,
                    lat: f.geometry.coordinates[1],
                    lon: f.geometry.coordinates[0],
                    depth: f.geometry.coordinates[2] || 0,
                    mag: f.properties.mag || 0,
                    place: f.properties.place,
                    time: f.properties.time
                }));

                // Find new earthquakes (ones we haven't seen)
                const oldIds = new Set(earthquakes.map(e => e.id));
                for (const eq of newQuakes) {
                    if (!oldIds.has(eq.id)) {
                        // New earthquake - add ring and play sound
                        const pos = project(eq.lat, eq.lon);
                        rings.push({
                            x: pos.x,
                            y: pos.y,
                            radius: 0,
                            maxRadius: 50 + eq.mag * 20,
                            color: magColor(eq.mag),
                            alpha: 1
                        });
                        playQuake(eq);
                    }
                }

                earthquakes = newQuakes;
                document.getElementById('status').textContent = `${earthquakes.length} quakes (24h)`;
            } catch (e) {
                document.getElementById('status').textContent = 'fetch error';
            }
        }

        // Continent outlines (simplified)
        const continents = [
            // North America
            [[71,-168],[66,-169],[60,-165],[55,-155],[60,-147],[55,-131],[49,-126],[42,-124],[36,-122],[31,-117],[25,-109],[26,-104],[29,-97],[28,-88],[25,-81],[29,-82],[35,-89],[40,-86],[47,-75],[52,-64],[59,-62],[65,-70],[71,-80],[76,-110],[76,-130],[73,-150],[71,-168]],
            // South America
            [[12,-72],[5,-78],[-4,-81],[-12,-77],[-20,-70],[-32,-64],[-44,-66],[-55,-66],[-52,-62],[-44,-55],[-36,-50],[-24,-43],[-12,-36],[0,-38],[8,-50],[12,-65],[12,-72]],
            // Europe
            [[71,28],[65,20],[58,5],[50,-6],[45,-2],[36,-6],[37,0],[46,10],[50,18],[56,25],[62,32],[68,30],[71,28]],
            // Africa
            [[37,-10],[31,2],[33,16],[36,25],[28,34],[16,40],[4,45],[-8,38],[-20,32],[-34,18],[-32,12],[-20,14],[-8,4],[4,-4],[16,-12],[28,-14],[37,-10]],
            // Asia
            [[77,100],[70,130],[61,148],[52,160],[44,148],[32,132],[20,108],[8,98],[8,104],[18,116],[10,118],[2,112],[-4,105],[0,90],[8,82],[20,72],[32,66],[44,52],[56,38],[64,38],[72,58],[78,95],[77,100]],
            // Australia
            [[-11,143],[-17,150],[-25,153],[-36,148],[-38,140],[-32,130],[-20,118],[-12,122],[-10,132],[-11,143]],
            // Antarctica
            [[-65,-60],[-70,-30],[-68,0],[-70,30],[-72,60],[-68,90],[-70,120],[-75,150],[-78,180],[-75,-150],[-70,-120],[-68,-90],[-65,-60]]
        ];

        // Draw frame
        function draw() {
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw graticule (light grid)
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.03)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let lat = -60; lat <= 80; lat += 30) {
                const { y } = project(lat, -180);
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
            }
            for (let lon = -180; lon <= 180; lon += 30) {
                const { x } = project(0, lon);
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
            }
            ctx.stroke();

            // Draw filled continents
            ctx.fillStyle = 'rgba(16, 185, 129, 0.06)';
            ctx.strokeStyle = 'rgba(16, 185, 129, 0.2)';
            ctx.lineWidth = 1;
            for (const points of continents) {
                ctx.beginPath();
                let first = true;
                for (const [lat, lon] of points) {
                    const { x, y } = project(lat, lon);
                    if (first) { ctx.moveTo(x, y); first = false; }
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }

            // Draw earthquakes as dots
            for (const eq of earthquakes) {
                const { x, y } = project(eq.lat, eq.lon);
                const radius = 2 + eq.mag;

                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fillStyle = magColor(eq.mag);
                ctx.globalAlpha = 0.7;
                ctx.fill();
                ctx.globalAlpha = 1;
            }

            // Draw and update rings
            for (let i = rings.length - 1; i >= 0; i--) {
                const ring = rings[i];
                ring.radius += 2;
                ring.alpha -= 0.02;

                if (ring.alpha <= 0) {
                    rings.splice(i, 1);
                    continue;
                }

                ctx.beginPath();
                ctx.arc(ring.x, ring.y, ring.radius, 0, Math.PI * 2);
                ctx.strokeStyle = ring.color;
                ctx.globalAlpha = ring.alpha;
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.globalAlpha = 1;
            }

            requestAnimationFrame(draw);
        }

        // Initial fetch and start
        fetchQuakes();
        setInterval(fetchQuakes, 30000); // Refresh every 30s
        draw();
    </script>
</body>
</html>
