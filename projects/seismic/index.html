<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seismic Activity — hyle</title>
    <meta name="description" content="Real-time earthquake visualization and sonification using USGS data">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>λ</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050506;
            --text: #f0f0f3;
            --text-secondary: #a0a0ab;
            --text-muted: #606068;
            --accent: #10b981;
            --accent-bright: #34d399;
            --border: #1a1a20;
            --blue: #3b82f6;
            --orange: #f97316;
            --red: #ef4444;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'SF Mono', Consolas, monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: var(--font-sans);
            overflow: hidden;
        }

        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            background: linear-gradient(to bottom, rgba(5,5,6,0.9), transparent);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text);
            text-decoration: none;
            font-weight: 600;
        }

        .brand .lambda { color: var(--accent); font-size: 1.25rem; }
        .brand:hover .lambda { color: var(--accent-bright); }

        .back-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.85rem;
            transition: color 0.2s;
        }

        .back-link:hover { color: var(--accent); }

        #globe { position: fixed; top: 0; left: 0; width: 100%; height: 100%; }

        #ui {
            position: fixed;
            bottom: 1.5rem;
            left: 1.5rem;
            right: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            pointer-events: none;
            z-index: 10;
        }

        #info {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
        }

        #info a {
            color: var(--accent);
            pointer-events: auto;
            text-decoration: none;
        }

        #info a:hover { color: var(--accent-bright); }

        #controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        button {
            background: rgba(10, 10, 15, 0.8);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 0.6rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            pointer-events: auto;
            font-family: var(--font-sans);
            font-size: 0.9rem;
            font-weight: 500;
            backdrop-filter: blur(12px);
            transition: all 0.2s;
        }

        button:hover {
            border-color: var(--accent);
            background: rgba(16, 185, 129, 0.15);
        }

        button.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg);
        }

        #status {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
            pointer-events: auto;
        }

        #legend {
            position: fixed;
            top: 70px;
            right: 1.5rem;
            background: rgba(10, 10, 15, 0.85);
            border: 1px solid var(--border);
            padding: 1rem 1.25rem;
            border-radius: 12px;
            font-size: 0.8rem;
            backdrop-filter: blur(12px);
        }

        #legend strong {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent);
            font-weight: 500;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin: 0.4rem 0;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
    </style>
</head>
<body>
    <nav>
        <a href="/" class="brand">
            <span class="lambda">λ</span>
            <span>hyle</span>
        </a>
        <a href="/projects/" class="back-link">← Projects</a>
    </nav>
    <canvas id="globe"></canvas>
    <div id="ui">
        <div id="info">
            data: <a href="https://earthquake.usgs.gov">USGS</a>
        </div>
        <div id="controls">
            <span id="status">loading...</span>
            <button id="sound" onclick="toggleSound()">sound off</button>
        </div>
    </div>
    <div id="legend">
        <div><strong>magnitude → pitch</strong></div>
        <div class="legend-item"><span class="legend-dot" style="background:#10b981"></span> M &lt; 3</div>
        <div class="legend-item"><span class="legend-dot" style="background:#3b82f6"></span> M 3-5</div>
        <div class="legend-item"><span class="legend-dot" style="background:#f97316"></span> M 5-7</div>
        <div class="legend-item"><span class="legend-dot" style="background:#ef4444"></span> M &gt; 7</div>
    </div>

    <script>
        const canvas = document.getElementById('globe');
        const ctx = canvas.getContext('2d');

        let width, height, centerX, centerY, scale;
        let rotation = 0;
        let earthquakes = [];
        let rings = [];
        let soundEnabled = false;
        let audioCtx = null;

        // ═══════════════════════════════════════════════════════════════════════════
        // HIGH-RESOLUTION NATURAL EARTH-STYLE GEOGRAPHY
        // ═══════════════════════════════════════════════════════════════════════════

        const GEOGRAPHY = {
            // Africa - detailed coastline
            africa: [
                [37.0,-9.0],[36.5,-6.0],[36.0,-3.0],[35.5,0.0],[35.5,3.0],[35.8,6.0],
                [36.0,9.0],[36.2,11.0],[35.8,13.0],[35.0,15.0],[34.5,17.0],[33.5,20.0],
                [32.5,23.0],[31.5,25.0],[31.0,27.0],[31.5,29.0],[31.5,31.0],[31.0,32.5],
                [30.0,33.5],[28.5,34.0],[27.0,34.5],[25.5,35.0],[23.5,35.5],[21.5,36.0],
                [19.0,37.0],[16.0,38.0],[13.5,39.5],[11.5,41.0],[9.5,42.5],[7.5,44.0],
                [5.5,45.5],[3.0,46.0],[0.5,45.5],[-2.0,44.5],[-4.5,42.5],[-7.0,40.0],
                [-10.0,37.0],[-13.0,34.0],[-16.0,30.0],[-18.0,26.0],[-20.0,22.0],
                [-22.5,18.0],[-25.0,15.0],[-27.5,13.0],[-30.0,12.0],[-32.5,14.0],
                [-34.5,17.0],[-35.5,20.0],[-34.5,23.0],[-33.0,26.0],[-31.0,28.0],
                [-28.5,30.0],[-26.0,31.0],[-23.0,32.0],[-20.0,33.0],[-17.0,32.0],
                [-14.5,30.0],[-12.0,27.0],[-10.0,24.0],[-8.0,21.0],[-6.0,18.0],
                [-4.0,15.0],[-2.0,12.5],[0.0,10.5],[2.0,9.0],[4.0,7.0],[6.0,5.0],
                [8.5,3.5],[10.5,2.5],[12.5,2.0],[14.5,3.0],[16.5,4.0],[18.0,6.0],
                [19.5,8.0],[21.0,9.5],[23.0,10.0],[25.0,9.0],[27.0,7.0],[29.0,4.0],
                [31.0,1.0],[33.0,-2.0],[35.0,-5.0],[36.5,-7.5],[37.0,-9.0]
            ],

            // Europe - detailed
            europe: [
                [36.0,-6.0],[37.0,-3.0],[38.0,0.0],[39.5,1.0],[41.0,2.0],[42.5,3.0],
                [43.5,5.0],[43.5,7.0],[44.0,8.5],[45.5,9.0],[46.0,11.0],[45.5,13.0],
                [45.0,14.0],[44.5,15.0],[43.5,16.0],[42.5,17.0],[41.5,18.0],[40.5,19.0],
                [39.5,20.0],[38.5,21.0],[37.5,22.0],[36.5,23.0],[36.0,24.0],[36.0,26.0],
                [37.0,27.0],[38.5,27.0],[40.0,26.0],[41.5,27.0],[42.5,28.5],[43.0,30.0],
                [44.0,32.0],[45.0,34.0],[46.5,35.0],[48.0,36.0],[50.0,37.0],[52.0,36.0],
                [54.0,34.0],[56.0,31.0],[58.0,28.0],[60.0,25.0],[61.5,22.0],[63.0,18.0],
                [64.0,14.0],[65.0,12.0],[66.0,14.0],[67.0,18.0],[68.0,22.0],[69.5,26.0],
                [71.0,28.0],[70.5,30.0],[69.5,28.0],[68.0,24.0],[66.5,20.0],[65.0,16.0],
                [64.0,14.0],[63.0,12.0],[62.0,10.0],[61.0,8.0],[60.0,6.0],[59.0,4.0],
                [58.0,2.0],[57.0,0.0],[56.0,-2.0],[55.0,-4.0],[54.0,-6.0],[53.0,-7.0],
                [52.0,-8.0],[51.0,-9.0],[50.0,-10.0],[49.0,-8.0],[48.0,-6.0],[47.0,-4.0],
                [46.5,-2.0],[46.0,-1.0],[45.5,-1.5],[44.5,-2.0],[43.5,-3.0],[42.5,-4.0],
                [41.5,-5.0],[40.5,-6.0],[39.0,-7.0],[37.5,-8.0],[36.0,-6.0]
            ],

            // British Isles
            britishIsles: [
                [50.0,-5.5],[50.5,-4.0],[51.0,-2.0],[51.5,0.0],[52.0,1.0],[53.0,0.5],
                [54.0,0.0],[55.0,-1.0],[56.0,-2.0],[57.0,-3.0],[58.0,-4.0],[58.5,-5.0],
                [58.5,-6.0],[58.0,-7.0],[57.0,-7.0],[56.0,-6.0],[55.5,-5.5],[55.0,-5.0],
                [54.5,-5.5],[54.0,-6.0],[53.5,-6.5],[53.0,-6.0],[52.5,-6.0],[52.0,-7.0],
                [51.5,-8.0],[51.0,-9.5],[50.5,-10.0],[50.0,-9.0],[49.5,-8.0],[50.0,-5.5]
            ],

            // Iceland
            iceland: [
                [66.5,-23.0],[66.0,-22.0],[65.5,-21.0],[64.5,-20.0],[64.0,-19.0],
                [63.5,-18.0],[63.5,-16.0],[64.0,-14.5],[64.5,-14.0],[65.0,-14.0],
                [65.5,-15.0],[66.0,-17.0],[66.5,-19.0],[66.5,-21.0],[66.5,-23.0]
            ],

            // North America Pacific coast
            northAmericaWest: [
                [72.0,-168.0],[71.0,-165.0],[70.0,-162.0],[69.0,-160.0],[68.0,-158.0],
                [66.0,-154.0],[64.0,-150.0],[62.0,-148.0],[60.0,-146.0],[58.0,-148.0],
                [56.0,-152.0],[54.0,-158.0],[53.0,-165.0],[54.0,-168.0],[56.0,-168.0],
                [58.0,-166.0],[60.0,-162.0],[58.0,-158.0],[55.0,-155.0],[52.0,-152.0],
                [50.0,-148.0],[48.0,-144.0],[46.0,-138.0],[44.0,-134.0],[42.0,-130.0],
                [40.0,-126.0],[38.0,-124.0],[36.0,-122.0],[34.0,-120.0],[32.0,-118.0],
                [30.0,-116.0],[28.0,-114.0],[26.0,-112.0],[24.0,-110.0],[23.0,-108.0],
                [22.5,-106.0]
            ],

            // North America Atlantic and Gulf
            northAmericaEast: [
                [22.5,-106.0],[24.0,-104.0],[26.0,-100.0],[28.0,-97.0],[29.0,-94.0],
                [29.5,-91.0],[30.0,-88.0],[29.0,-85.0],[27.0,-82.5],[25.5,-80.5],
                [25.0,-81.0],[26.0,-83.0],[27.5,-84.0],[29.0,-85.0],[30.0,-87.0],
                [30.5,-89.0],[29.5,-91.0],[29.0,-93.5],[28.0,-96.0],[26.5,-97.5],
                [25.5,-97.5],[26.0,-99.0],[27.5,-100.0],[29.0,-101.0],[30.5,-103.0],
                [31.5,-105.0],[32.0,-108.0],[31.5,-111.0],[32.5,-115.0],[34.0,-118.0],
                [36.0,-121.0],[38.0,-122.5],[40.0,-124.0],[42.0,-124.5],[44.0,-124.5],
                [46.0,-124.0],[48.0,-123.0],[49.0,-123.5],[50.0,-126.0],[52.0,-128.0],
                [54.0,-131.0],[56.0,-134.0],[58.0,-137.0],[60.0,-141.0]
            ],

            // East Coast continuation
            eastCoast: [
                [25.5,-80.5],[27.0,-80.0],[29.0,-81.0],[31.0,-81.5],[33.0,-79.5],
                [35.0,-76.0],[37.0,-76.0],[38.0,-75.0],[39.0,-75.0],[40.0,-74.0],
                [41.0,-72.0],[42.0,-70.0],[43.5,-69.5],[44.5,-67.0],[45.5,-66.0],
                [47.0,-64.0],[48.5,-60.0],[50.0,-56.0],[52.0,-55.5],[54.0,-56.5],
                [56.0,-59.0],[58.0,-63.0],[60.0,-67.0],[62.0,-72.0],[64.0,-77.0],
                [66.0,-82.0],[68.0,-88.0],[70.0,-96.0],[72.0,-106.0],[74.0,-120.0],
                [75.0,-140.0],[74.0,-156.0],[72.0,-168.0]
            ],

            // Central America
            centralAmerica: [
                [22.0,-105.0],[21.0,-102.0],[20.0,-98.0],[19.0,-95.0],[18.0,-92.0],
                [17.0,-89.0],[16.0,-86.0],[15.0,-84.0],[14.0,-82.0],[12.5,-80.0],
                [11.0,-78.0],[9.5,-79.0],[8.0,-80.0],[7.5,-78.0],[9.0,-77.0],
                [10.5,-76.0],[12.0,-75.0],[13.5,-76.0],[15.0,-78.0],[16.5,-80.0],
                [18.0,-84.0],[19.0,-88.0],[20.0,-92.0],[21.0,-97.0],[22.0,-102.0],
                [22.0,-105.0]
            ],

            // South America
            southAmerica: [
                [12.0,-72.0],[10.5,-75.0],[9.0,-77.0],[7.0,-78.0],[5.0,-78.0],
                [3.0,-79.0],[1.0,-80.0],[-1.0,-80.5],[-3.0,-81.0],[-5.0,-81.0],
                [-7.0,-80.0],[-9.0,-78.0],[-11.0,-77.0],[-13.0,-76.0],[-15.0,-75.0],
                [-17.0,-73.0],[-19.0,-70.0],[-21.0,-68.0],[-23.0,-66.0],[-25.0,-65.0],
                [-27.0,-65.0],[-29.0,-66.0],[-31.0,-66.0],[-33.0,-67.0],[-35.0,-68.0],
                [-37.0,-69.0],[-39.0,-70.0],[-41.0,-72.0],[-43.0,-73.0],[-45.0,-74.0],
                [-47.0,-74.0],[-49.0,-74.0],[-51.0,-73.0],[-53.0,-71.0],[-55.0,-68.0],
                [-56.0,-66.0],[-55.0,-64.0],[-53.0,-65.0],[-51.0,-68.0],[-49.0,-67.0],
                [-47.0,-65.0],[-45.0,-62.0],[-43.0,-59.0],[-41.0,-56.0],[-39.0,-54.0],
                [-37.0,-52.0],[-35.0,-50.0],[-33.0,-49.0],[-31.0,-48.0],[-29.0,-47.0],
                [-27.0,-46.0],[-25.0,-44.0],[-23.0,-42.0],[-21.0,-40.0],[-19.0,-38.0],
                [-17.0,-36.0],[-15.0,-35.0],[-13.0,-36.0],[-11.0,-37.0],[-9.0,-35.0],
                [-7.0,-34.5],[-5.0,-35.0],[-3.0,-38.0],[-1.0,-42.0],[1.0,-48.0],
                [3.0,-52.0],[5.0,-56.0],[7.0,-60.0],[9.0,-64.0],[10.5,-68.0],[12.0,-72.0]
            ],

            // Asia mainland
            asia: [
                [77.0,100.0],[76.0,110.0],[74.0,120.0],[72.0,130.0],[70.0,140.0],
                [68.0,148.0],[66.0,155.0],[64.0,160.0],[62.0,163.0],[60.0,165.0],
                [58.0,163.0],[56.0,159.0],[54.0,156.0],[52.0,155.0],[50.0,156.0],
                [48.0,152.0],[46.0,145.0],[44.0,140.0],[42.0,136.0],[40.0,132.0],
                [38.0,128.0],[36.0,126.0],[35.0,124.0],[36.0,120.0],[38.0,118.0],
                [40.0,117.0],[39.0,115.0],[37.0,115.0],[35.0,116.0],[33.0,118.0],
                [31.0,122.0],[29.0,122.0],[27.0,121.0],[25.0,118.0],[23.0,116.0],
                [21.0,112.0],[19.0,108.0],[17.0,107.0],[15.0,109.0],[13.0,110.0],
                [11.0,108.0],[9.0,104.0],[7.0,100.0],[5.0,98.0],[3.0,100.0],
                [1.0,103.0],[-1.0,104.0],[-3.0,102.0],[-5.0,100.0],[-3.0,98.0],
                [-1.0,97.0],[1.0,95.0],[4.0,92.0],[8.0,88.0],[12.0,84.0],
                [16.0,80.0],[20.0,76.0],[24.0,72.0],[28.0,68.0],[32.0,64.0],
                [36.0,60.0],[40.0,56.0],[44.0,52.0],[48.0,48.0],[52.0,44.0],
                [56.0,40.0],[60.0,38.0],[64.0,42.0],[68.0,48.0],[71.0,56.0],
                [73.0,66.0],[75.0,78.0],[77.0,90.0],[77.0,100.0]
            ],

            // India
            india: [
                [35.0,74.0],[33.0,76.0],[31.0,78.0],[29.0,82.0],[27.0,86.0],
                [25.0,89.0],[23.0,92.0],[21.0,92.0],[19.0,88.0],[17.0,84.0],
                [15.0,80.0],[13.0,78.0],[11.0,77.0],[9.0,76.0],[8.0,77.0],
                [9.0,79.0],[11.0,80.0],[13.0,80.0],[15.0,79.0],[17.0,78.0],
                [19.0,76.0],[21.0,74.0],[23.0,72.0],[25.0,70.0],[27.0,68.0],
                [29.0,68.0],[31.0,70.0],[33.0,72.0],[35.0,74.0]
            ],

            // Japan
            japan: [
                [45.5,142.0],[44.5,143.0],[43.5,145.0],[42.0,144.0],[41.0,142.0],
                [40.0,140.0],[39.0,138.0],[38.0,137.0],[37.0,137.0],[36.0,136.0],
                [35.0,135.0],[34.0,133.0],[33.0,131.0],[32.5,130.0],[33.0,129.5],
                [34.0,130.5],[35.0,132.0],[36.0,134.0],[37.0,136.0],[38.0,138.0],
                [39.0,140.0],[40.0,141.0],[41.0,142.0],[42.0,143.0],[43.0,145.0],
                [44.0,145.0],[45.0,143.0],[45.5,142.0]
            ],

            // Indonesia
            indonesia: [
                [6.0,95.0],[4.0,98.0],[2.0,102.0],[0.0,104.0],[-2.0,106.0],
                [-4.0,108.0],[-6.0,106.0],[-8.0,108.0],[-8.5,115.0],[-8.0,120.0],
                [-6.0,125.0],[-4.0,128.0],[-2.0,130.0],[0.0,128.0],[2.0,125.0],
                [4.0,120.0],[5.0,118.0],[4.0,115.0],[2.0,112.0],[1.0,108.0],
                [2.0,104.0],[4.0,100.0],[6.0,95.0]
            ],

            // Philippines
            philippines: [
                [19.0,120.0],[18.0,121.0],[16.0,122.0],[14.0,123.0],[12.0,124.0],
                [10.0,124.0],[8.0,123.0],[6.0,122.0],[5.5,120.0],[7.0,118.0],
                [9.0,117.0],[11.0,117.0],[13.0,118.0],[15.0,119.0],[17.0,120.0],
                [19.0,120.0]
            ],

            // Australia
            australia: [
                [-10.5,142.0],[-12.0,143.0],[-14.0,144.0],[-16.0,146.0],[-18.0,148.0],
                [-20.0,149.0],[-22.0,150.0],[-24.0,152.0],[-26.0,153.0],[-28.0,153.5],
                [-30.0,153.0],[-32.0,152.0],[-34.0,151.0],[-36.0,150.0],[-38.0,147.0],
                [-39.0,144.0],[-38.0,141.0],[-36.0,137.0],[-34.0,133.0],[-32.0,128.0],
                [-30.0,123.0],[-28.0,118.0],[-26.0,114.0],[-24.0,113.0],[-22.0,114.0],
                [-20.0,116.0],[-18.0,118.0],[-16.0,122.0],[-14.0,126.0],[-12.0,130.0],
                [-11.0,133.0],[-12.0,136.0],[-14.0,138.0],[-12.0,140.0],[-10.5,142.0]
            ],

            // New Zealand
            newZealand: [
                [-34.0,173.0],[-35.0,174.0],[-37.0,175.0],[-39.0,176.0],[-41.0,177.0],
                [-42.0,174.0],[-44.0,172.0],[-46.0,169.0],[-47.0,168.0],[-46.0,166.0],
                [-44.0,168.0],[-42.0,172.0],[-40.0,175.0],[-38.0,178.0],[-36.0,176.0],
                [-34.0,173.0]
            ],

            // Greenland
            greenland: [
                [84.0,-35.0],[82.0,-28.0],[80.0,-22.0],[78.0,-18.0],[76.0,-20.0],
                [74.0,-24.0],[72.0,-28.0],[70.0,-32.0],[68.0,-38.0],[66.0,-44.0],
                [65.0,-52.0],[66.0,-56.0],[68.0,-58.0],[70.0,-54.0],[72.0,-48.0],
                [74.0,-42.0],[76.0,-38.0],[78.0,-36.0],[80.0,-38.0],[82.0,-40.0],
                [84.0,-35.0]
            ],

            // Madagascar
            madagascar: [
                [-12.0,49.0],[-14.0,50.0],[-16.0,50.0],[-18.0,49.0],[-20.0,48.0],
                [-22.0,47.0],[-24.0,46.0],[-25.5,45.0],[-24.0,44.0],[-22.0,44.0],
                [-20.0,45.0],[-18.0,46.0],[-16.0,47.0],[-14.0,48.0],[-12.0,49.0]
            ],

            // Antarctica edge
            antarctica: [
                [-66.0,-60.0],[-68.0,-40.0],[-70.0,-20.0],[-72.0,0.0],[-72.0,20.0],
                [-70.0,40.0],[-68.0,60.0],[-70.0,80.0],[-72.0,100.0],[-74.0,120.0],
                [-76.0,140.0],[-78.0,160.0],[-80.0,180.0],[-78.0,-160.0],[-76.0,-140.0],
                [-74.0,-120.0],[-72.0,-100.0],[-70.0,-80.0],[-66.0,-60.0]
            ],

            // Arabian Peninsula
            arabia: [
                [30.0,35.0],[28.0,37.0],[26.0,40.0],[24.0,44.0],[22.0,50.0],
                [20.0,55.0],[18.0,56.0],[15.0,52.0],[13.0,48.0],[12.5,44.0],
                [14.0,42.0],[16.0,40.0],[18.0,38.0],[20.0,36.0],[22.0,34.5],
                [24.0,34.0],[26.0,34.0],[28.0,35.0],[30.0,35.0]
            ]
        };

        const continents = Object.values(GEOGRAPHY);

        // Stereographic projection with tilt
        function project(lat, lon) {
            const phi = (90 - lat) * Math.PI / 180;
            const theta = (lon + rotation) * Math.PI / 180;

            const x3 = Math.sin(phi) * Math.cos(theta);
            const y3 = Math.cos(phi);
            const z3 = Math.sin(phi) * Math.sin(theta);

            const tilt = 0.4;
            const y3t = y3 * Math.cos(tilt) - z3 * Math.sin(tilt);
            const z3t = y3 * Math.sin(tilt) + z3 * Math.cos(tilt);

            const k = 2 / (1 + Math.max(0.01, 1 - z3t * 0.8));
            const x = x3 * k;
            const y = y3t * k;

            return {
                x: centerX + x * scale * 0.5,
                y: centerY - y * scale * 0.5,
                visible: z3t > -0.3,
                depth: z3t
            };
        }

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            centerX = width / 2;
            centerY = height / 2;
            scale = Math.min(width, height) * 0.7;
        }
        resize();
        window.addEventListener('resize', resize);

        function magColor(mag) {
            if (mag < 3) return '#10b981';
            if (mag < 5) return '#3b82f6';
            if (mag < 7) return '#f97316';
            return '#ef4444';
        }

        function magFreq(mag) { return 80 + (mag / 10) * 720; }
        function depthDuration(depth) { return 0.1 + (depth / 700) * 2.9; }

        function playQuake(eq) {
            if (!soundEnabled || !audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const pan = audioCtx.createStereoPanner();
            osc.type = 'sine';
            osc.frequency.value = magFreq(eq.mag);
            pan.pan.value = Math.max(-1, Math.min(1, eq.lon / 180));
            const duration = depthDuration(eq.depth);
            const now = audioCtx.currentTime;
            gain.gain.setValueAtTime(0.3, now);
            gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
            osc.connect(gain);
            gain.connect(pan);
            pan.connect(audioCtx.destination);
            osc.start(now);
            osc.stop(now + duration);
        }

        function toggleSound() {
            const btn = document.getElementById('sound');
            soundEnabled = !soundEnabled;
            btn.textContent = soundEnabled ? 'sound on' : 'sound off';
            btn.classList.toggle('active', soundEnabled);
            if (soundEnabled && !audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        async function fetchQuakes() {
            try {
                const res = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson');
                const data = await res.json();
                const newQuakes = data.features.map(f => ({
                    id: f.id,
                    lat: f.geometry.coordinates[1],
                    lon: f.geometry.coordinates[0],
                    depth: f.geometry.coordinates[2] || 0,
                    mag: f.properties.mag || 0,
                    place: f.properties.place,
                    time: f.properties.time
                }));

                const oldIds = new Set(earthquakes.map(e => e.id));
                for (const eq of newQuakes) {
                    if (!oldIds.has(eq.id)) {
                        const p = project(eq.lat, eq.lon);
                        if (p.visible) {
                            rings.push({
                                lat: eq.lat,
                                lon: eq.lon,
                                radius: 0,
                                maxRadius: 30 + eq.mag * 15,
                                color: magColor(eq.mag),
                                alpha: 1
                            });
                            playQuake(eq);
                        }
                    }
                }

                earthquakes = newQuakes;
                document.getElementById('status').textContent = `${earthquakes.length} quakes (24h)`;
            } catch (e) {
                document.getElementById('status').textContent = 'fetch error';
            }
        }

        // Catmull-Rom spline for smooth curves
        function catmullRom(p0, p1, p2, p3, t) {
            const t2 = t * t;
            const t3 = t2 * t;
            return 0.5 * (
                (2 * p1) +
                (-p0 + p2) * t +
                (2*p0 - 5*p1 + 4*p2 - p3) * t2 +
                (-p0 + 3*p1 - 3*p2 + p3) * t3
            );
        }

        function drawSmoothContinent(points, fill = true) {
            if (points.length < 4) return;

            ctx.beginPath();
            let started = false;
            let lastVisible = false;

            // Extended points for closed curve
            const ext = [...points, points[0], points[1], points[2]];

            for (let i = 0; i < points.length; i++) {
                const p0 = ext[i];
                const p1 = ext[i + 1];
                const p2 = ext[i + 2];
                const p3 = ext[i + 3];

                // Interpolate between p1 and p2
                for (let t = 0; t <= 1; t += 0.2) {
                    const lat = catmullRom(p0[0], p1[0], p2[0], p3[0], t);
                    const lon = catmullRom(p0[1], p1[1], p2[1], p3[1], t);
                    const proj = project(lat, lon);

                    if (proj.visible) {
                        if (!started || !lastVisible) {
                            ctx.moveTo(proj.x, proj.y);
                            started = true;
                        } else {
                            ctx.lineTo(proj.x, proj.y);
                        }
                        lastVisible = true;
                    } else {
                        if (started && lastVisible) {
                            // Close current segment
                        }
                        lastVisible = false;
                    }
                }
            }

            if (started) {
                ctx.closePath();
                if (fill) ctx.fill();
                ctx.stroke();
            }
        }

        function draw() {
            ctx.fillStyle = '#050506';
            ctx.fillRect(0, 0, width, height);

            // Globe glow
            const glow = ctx.createRadialGradient(centerX, centerY, scale * 0.1, centerX, centerY, scale * 0.5);
            glow.addColorStop(0, 'transparent');
            glow.addColorStop(0.8, 'rgba(16, 185, 129, 0.02)');
            glow.addColorStop(1, 'transparent');
            ctx.fillStyle = glow;
            ctx.fillRect(0, 0, width, height);

            // Graticule
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.025)';
            ctx.lineWidth = 1;

            for (let lat = -60; lat <= 60; lat += 15) {
                ctx.beginPath();
                let first = true;
                for (let lon = -180; lon <= 180; lon += 3) {
                    const p = project(lat, lon);
                    if (p.visible) {
                        if (first) { ctx.moveTo(p.x, p.y); first = false; }
                        else ctx.lineTo(p.x, p.y);
                    } else first = true;
                }
                ctx.stroke();
            }

            for (let lon = -180; lon < 180; lon += 15) {
                ctx.beginPath();
                let first = true;
                for (let lat = -80; lat <= 80; lat += 3) {
                    const p = project(lat, lon);
                    if (p.visible) {
                        if (first) { ctx.moveTo(p.x, p.y); first = false; }
                        else ctx.lineTo(p.x, p.y);
                    } else first = true;
                }
                ctx.stroke();
            }

            // Continents with smooth rendering
            ctx.fillStyle = 'rgba(16, 185, 129, 0.06)';
            ctx.strokeStyle = 'rgba(16, 185, 129, 0.3)';
            ctx.lineWidth = 1.2;

            for (const cont of continents) {
                drawSmoothContinent(cont);
            }

            // Earthquakes
            for (const eq of earthquakes) {
                const p = project(eq.lat, eq.lon);
                if (!p.visible) continue;

                const radius = 3 + eq.mag * 1.5;
                const alpha = 0.5 + p.depth * 0.3;

                ctx.beginPath();
                ctx.arc(p.x, p.y, radius, 0, Math.PI * 2);
                ctx.fillStyle = magColor(eq.mag);
                ctx.globalAlpha = alpha;
                ctx.fill();
                ctx.globalAlpha = 1;
            }

            // Rings
            for (let i = rings.length - 1; i >= 0; i--) {
                const ring = rings[i];
                ring.radius += 1.5;
                ring.alpha -= 0.015;

                if (ring.alpha <= 0) {
                    rings.splice(i, 1);
                    continue;
                }

                const p = project(ring.lat, ring.lon);
                if (!p.visible) continue;

                ctx.beginPath();
                ctx.arc(p.x, p.y, ring.radius, 0, Math.PI * 2);
                ctx.strokeStyle = ring.color;
                ctx.globalAlpha = ring.alpha;
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.globalAlpha = 1;
            }

            rotation += 0.02;
            requestAnimationFrame(draw);
        }

        fetchQuakes();
        setInterval(fetchQuakes, 30000);
        draw();
    </script>
</body>
</html>
