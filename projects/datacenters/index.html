<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datacenters Globe — hyle</title>
    <meta name="description" content="Interactive 3D visualization of global cloud infrastructure and environmental impact">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>λ</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050506;
            --bg-elevated: #0a0a0f;
            --text: #f0f0f3;
            --text-secondary: #a0a0ab;
            --text-muted: #606068;
            --accent: #10b981;
            --accent-bright: #34d399;
            --border: #1a1a20;
            --water: #3b82f6;
            --power: #eab308;
            --fire: #ef4444;
            --warning: #f97316;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'SF Mono', Consolas, monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: var(--font-sans);
            min-height: 100vh;
            overflow: hidden;
        }

        /* Nav */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            background: linear-gradient(to bottom, rgba(5,5,6,0.9), transparent);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text);
            text-decoration: none;
            font-weight: 600;
        }

        .brand .lambda { color: var(--accent); font-size: 1.25rem; }
        .brand:hover .lambda { color: var(--accent-bright); }

        .back-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: color 0.2s;
        }

        .back-link:hover { color: var(--accent); }

        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .panel {
            position: fixed;
            background: rgba(10, 10, 15, 0.85);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            pointer-events: auto;
            backdrop-filter: blur(16px);
        }

        .stats-panel {
            top: 70px;
            left: 20px;
            min-width: 240px;
        }

        .token-panel {
            top: 70px;
            right: 20px;
            text-align: right;
        }

        .legend-panel {
            bottom: 20px;
            left: 20px;
        }

        .detail-panel {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 400px;
            display: none;
            z-index: 100;
        }

        .detail-panel.visible { display: block; }

        h2 {
            font-family: var(--font-mono);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--accent);
            margin-bottom: 12px;
            font-weight: 500;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-size: 12px;
        }

        .stat-label { color: var(--text-muted); font-size: 0.85rem; }
        .stat-value { color: var(--text); font-weight: 600; font-family: var(--font-mono); }
        .stat-value.water { color: var(--water); }
        .stat-value.power { color: var(--power); }
        .stat-value.fire { color: var(--fire); }

        .token-counter {
            font-size: 2.5rem;
            font-weight: 300;
            color: var(--accent);
            letter-spacing: -2px;
            font-family: var(--font-mono);
        }

        .token-label {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 6px 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            color: var(--text);
            background: rgba(255,255,255,0.1);
        }

        .impact-meter {
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            margin: 8px 0;
            overflow: hidden;
        }

        .impact-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 0.75rem;
            color: var(--text-muted);
            pointer-events: none;
            font-family: var(--font-mono);
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <nav>
        <a href="/" class="brand">
            <span class="lambda">λ</span>
            <span>hyle</span>
        </a>
        <a href="/projects/" class="back-link">← Projects</a>
    </nav>

    <canvas id="canvas"></canvas>
    <div id="overlay">
        <div class="panel stats-panel">
            <h2>Global Impact</h2>
            <div class="stat-row">
                <span class="stat-label">Active Datacenters</span>
                <span class="stat-value" id="dcCount">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Water Usage</span>
                <span class="stat-value water" id="waterUsage">0 ML/day</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Power Draw</span>
                <span class="stat-value power" id="powerDraw">0 GW</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Fire Risk Zones</span>
                <span class="stat-value fire" id="fireRisk">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Drought Index</span>
                <span class="stat-value" id="droughtIdx">0.0</span>
            </div>
        </div>

        <div class="panel token-panel">
            <div class="token-counter" id="tokenCount">0</div>
            <div class="token-label">tokens generated</div>
            <div class="stat-row" style="margin-top: 12px;">
                <span class="stat-label">Est. Water</span>
                <span class="stat-value water" id="tokenWater">0 L</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Est. CO2</span>
                <span class="stat-value" id="tokenCO2">0 g</span>
            </div>
        </div>

        <div class="panel legend-panel">
            <h2>Legend</h2>
            <div class="legend-item">
                <div class="legend-dot" style="background: var(--accent);"></div>
                <span>Cloud Datacenter</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: var(--fire);"></div>
                <span>High Fire Risk</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: var(--water);"></div>
                <span>Water Stress Zone</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: var(--power);"></div>
                <span>Grid Strain</span>
            </div>
        </div>

        <div class="panel detail-panel" id="detailPanel">
            <button class="close-btn" onclick="closeDetail()">&times;</button>
            <h2 id="dcName">Datacenter</h2>
            <div class="stat-row">
                <span class="stat-label">Provider</span>
                <span class="stat-value" id="dcProvider">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Capacity</span>
                <span class="stat-value" id="dcCapacity">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Water/day</span>
                <span class="stat-value water" id="dcWater">-</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Power</span>
                <span class="stat-value power" id="dcPower">-</span>
            </div>
            <h2 style="margin-top: 16px;">Environmental Impact</h2>
            <div class="stat-row">
                <span class="stat-label">Fire Risk</span>
            </div>
            <div class="impact-meter">
                <div class="impact-fill" id="dcFireBar" style="background: var(--fire); width: 0%;"></div>
            </div>
            <div class="stat-row">
                <span class="stat-label">Drought Contribution</span>
            </div>
            <div class="impact-meter">
                <div class="impact-fill" id="dcDroughtBar" style="background: var(--warning); width: 0%;"></div>
            </div>
            <div class="stat-row">
                <span class="stat-label">Grid Load</span>
            </div>
            <div class="impact-meter">
                <div class="impact-fill" id="dcGridBar" style="background: var(--power); width: 0%;"></div>
            </div>
        </div>
    </div>

    <div class="hint">click datacenter to inspect | scroll to zoom</div>

    <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let width, height, centerX, centerY, scale;
    let rotation = 0;
    let targetRotation = 0;
    let zoom = 1;
    let time = 0;
    let tokens = 0;
    let selectedDC = null;

    // Major cloud datacenter locations (lat, lon, provider, name, capacity MW)
    const datacenters = [
        // AWS
        { lat: 38.95, lon: -77.45, provider: 'AWS', name: 'us-east-1 (N. Virginia)', capacity: 500, water: 4.2, fire: 0.3 },
        { lat: 45.52, lon: -122.68, provider: 'AWS', name: 'us-west-2 (Oregon)', capacity: 400, water: 2.8, fire: 0.7 },
        { lat: 37.77, lon: -122.42, provider: 'AWS', name: 'us-west-1 (N. California)', capacity: 200, water: 3.5, fire: 0.85 },
        { lat: 51.51, lon: -0.13, provider: 'AWS', name: 'eu-west-2 (London)', capacity: 250, water: 1.5, fire: 0.1 },
        { lat: 50.11, lon: 8.68, provider: 'AWS', name: 'eu-central-1 (Frankfurt)', capacity: 350, water: 2.0, fire: 0.2 },
        { lat: 35.68, lon: 139.69, provider: 'AWS', name: 'ap-northeast-1 (Tokyo)', capacity: 300, water: 2.5, fire: 0.15 },
        { lat: 1.35, lon: 103.82, provider: 'AWS', name: 'ap-southeast-1 (Singapore)', capacity: 280, water: 3.0, fire: 0.05 },
        // Google
        { lat: 33.45, lon: -111.95, provider: 'Google', name: 'us-west-phoenix', capacity: 450, water: 5.0, fire: 0.9 },
        { lat: 35.23, lon: -80.84, provider: 'Google', name: 'us-east-charlotte', capacity: 380, water: 3.2, fire: 0.4 },
        { lat: 45.59, lon: -121.18, provider: 'Google', name: 'us-west-dalles', capacity: 600, water: 1.8, fire: 0.6 },
        { lat: 53.55, lon: -6.27, provider: 'Google', name: 'eu-west-dublin', capacity: 320, water: 1.2, fire: 0.1 },
        { lat: 52.37, lon: 4.90, provider: 'Google', name: 'eu-west-amsterdam', capacity: 280, water: 1.0, fire: 0.05 },
        { lat: 25.20, lon: 55.27, provider: 'Google', name: 'me-dubai', capacity: 200, water: 6.0, fire: 0.95 },
        // Azure
        { lat: 41.88, lon: -87.63, provider: 'Azure', name: 'us-central-chicago', capacity: 420, water: 2.5, fire: 0.2 },
        { lat: 47.61, lon: -122.33, provider: 'Azure', name: 'us-west-seattle', capacity: 380, water: 1.5, fire: 0.5 },
        { lat: 32.78, lon: -96.80, provider: 'Azure', name: 'us-south-dallas', capacity: 350, water: 4.0, fire: 0.75 },
        { lat: -33.87, lon: 151.21, provider: 'Azure', name: 'au-east-sydney', capacity: 250, water: 3.5, fire: 0.8 },
        { lat: 19.08, lon: 72.88, provider: 'Azure', name: 'in-west-mumbai', capacity: 300, water: 4.5, fire: 0.3 },
        // Meta
        { lat: 35.77, lon: -78.64, provider: 'Meta', name: 'us-east-raleigh', capacity: 500, water: 3.8, fire: 0.35 },
        { lat: 41.26, lon: -95.94, provider: 'Meta', name: 'us-central-omaha', capacity: 400, water: 2.2, fire: 0.25 },
        { lat: 64.15, lon: -21.94, provider: 'Meta', name: 'eu-north-iceland', capacity: 200, water: 0.2, fire: 0.01 },
    ];

    // Dymaxion/Fuller-inspired projection
    // Uses icosahedral gnomonic projection with continuous rotation
    function project(lat, lon) {
        const phi = (90 - lat) * Math.PI / 180;
        const theta = (lon + rotation) * Math.PI / 180;

        // Convert to 3D sphere
        const x3 = Math.sin(phi) * Math.cos(theta);
        const y3 = Math.cos(phi);  // Y is up
        const z3 = Math.sin(phi) * Math.sin(theta);

        // Fuller/Dymaxion-style: tilt the globe to show more landmass
        const tilt = 0.4;  // 23 degrees tilt
        const y3t = y3 * Math.cos(tilt) - z3 * Math.sin(tilt);
        const z3t = y3 * Math.sin(tilt) + z3 * Math.cos(tilt);

        // Stereographic projection (better for Dymaxion feel)
        const k = 2 / (1 + Math.max(0.01, 1 - z3t * 0.8));
        const x = x3 * k;
        const y = y3t * k;

        return {
            x: centerX + x * scale * zoom * 0.5,
            y: centerY - y * scale * zoom * 0.5,
            visible: z3t > -0.3,
            depth: z3t
        };
    }

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
        centerX = width / 2;
        centerY = height / 2;
        scale = Math.min(width, height) * 0.35;
    }

    function drawGlobe() {
        // Draw globe edge glow
        const edgeGlow = ctx.createRadialGradient(centerX, centerY, scale * zoom * 0.3, centerX, centerY, scale * zoom * 0.6);
        edgeGlow.addColorStop(0, 'transparent');
        edgeGlow.addColorStop(0.8, 'rgba(16, 185, 129, 0.03)');
        edgeGlow.addColorStop(1, 'transparent');
        ctx.fillStyle = edgeGlow;
        ctx.fillRect(0, 0, width, height);

        // Draw graticule (lat/lon lines)
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.04)';
        ctx.lineWidth = 1;

        // Latitude lines
        for (let lat = -60; lat <= 60; lat += 20) {
            ctx.beginPath();
            let first = true;
            for (let lon = -180; lon <= 180; lon += 3) {
                const p = project(lat, lon);
                if (p.visible) {
                    if (first) {
                        ctx.moveTo(p.x, p.y);
                        first = false;
                    } else {
                        ctx.lineTo(p.x, p.y);
                    }
                } else {
                    first = true;
                }
            }
            ctx.stroke();
        }

        // Longitude lines
        for (let lon = -180; lon < 180; lon += 20) {
            ctx.beginPath();
            let first = true;
            for (let lat = -85; lat <= 85; lat += 3) {
                const p = project(lat, lon);
                if (p.visible) {
                    if (first) {
                        ctx.moveTo(p.x, p.y);
                        first = false;
                    } else {
                        ctx.lineTo(p.x, p.y);
                    }
                } else {
                    first = true;
                }
            }
            ctx.stroke();
        }

        // Draw detailed continents
        drawContinentOutlines();

        // Draw equator highlight
        ctx.strokeStyle = 'rgba(16, 185, 129, 0.15)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        let first = true;
        for (let lon = -180; lon <= 180; lon += 3) {
            const p = project(0, lon);
            if (p.visible) {
                if (first) {
                    ctx.moveTo(p.x, p.y);
                    first = false;
                } else {
                    ctx.lineTo(p.x, p.y);
                }
            } else {
                first = true;
            }
        }
        ctx.stroke();
    }

    function drawContinentOutlines() {
        // Draw filled continents with gradient
        const continents = [
            // North America (detailed)
            [[71,-168],[66,-169],[64,-166],[60,-165],[58,-162],[56,-158],[55,-155],[57,-153],[59,-150],[60,-147],[60,-142],[59,-138],[57,-135],[55,-131],[53,-128],[49,-126],[46,-124],[42,-124],[39,-123],[36,-122],[33,-120],[31,-117],[29,-114],[27,-111],[25,-109],[24,-106],[26,-104],[28,-100],[29,-97],[30,-94],[29,-91],[28,-88],[26,-85],[25,-81],[27,-80],[29,-82],[30,-85],[32,-87],[35,-89],[38,-88],[40,-86],[43,-83],[45,-79],[47,-75],[49,-70],[50,-66],[52,-64],[54,-61],[56,-60],[59,-62],[61,-65],[63,-68],[65,-70],[68,-72],[70,-75],[71,-80],[72,-85],[73,-90],[74,-95],[75,-100],[76,-110],[77,-120],[76,-130],[74,-140],[73,-150],[72,-160],[71,-168]],
            // South America (detailed)
            [[12,-72],[10,-75],[8,-77],[5,-78],[2,-79],[-1,-80],[-4,-81],[-8,-80],[-12,-77],[-16,-75],[-20,-70],[-24,-66],[-28,-65],[-32,-64],[-36,-63],[-40,-64],[-44,-66],[-48,-68],[-52,-70],[-54,-69],[-55,-66],[-54,-64],[-52,-62],[-48,-58],[-44,-55],[-40,-52],[-36,-50],[-32,-48],[-28,-46],[-24,-43],[-20,-40],[-16,-38],[-12,-36],[-8,-35],[-4,-35],[0,-38],[4,-42],[8,-50],[10,-55],[11,-60],[12,-65],[12,-72]],
            // Europe (detailed)
            [[71,28],[70,30],[68,25],[65,20],[62,12],[60,8],[58,5],[55,0],[52,-4],[50,-6],[48,-5],[45,-2],[43,0],[40,-5],[36,-6],[35,-3],[37,0],[39,3],[42,6],[44,8],[46,10],[48,12],[49,15],[50,18],[52,20],[54,22],[56,25],[58,28],[60,30],[62,32],[64,35],[66,32],[68,30],[71,28]],
            // Africa (detailed)
            [[37,-10],[35,-6],[33,-2],[31,2],[30,8],[31,12],[33,16],[35,20],[36,25],[35,30],[32,32],[28,34],[24,36],[20,38],[16,40],[12,42],[8,44],[4,45],[0,43],[-4,40],[-8,38],[-12,36],[-16,34],[-20,32],[-24,28],[-28,24],[-32,20],[-34,18],[-35,16],[-34,14],[-32,12],[-28,10],[-24,12],[-20,14],[-16,12],[-12,8],[-8,4],[-4,2],[0,0],[4,-4],[8,-6],[12,-8],[16,-12],[20,-16],[24,-16],[28,-14],[32,-12],[37,-10]],
            // Asia (detailed)
            [[77,100],[75,110],[73,120],[70,130],[67,140],[64,145],[61,148],[58,152],[55,158],[52,160],[48,155],[44,148],[40,142],[36,138],[32,132],[28,122],[24,115],[20,108],[16,100],[12,95],[8,98],[6,100],[8,104],[12,108],[16,112],[18,116],[15,120],[10,118],[5,115],[2,112],[0,108],[-4,105],[-8,100],[-4,95],[0,90],[4,88],[8,82],[12,78],[16,75],[20,72],[24,70],[28,68],[32,66],[36,62],[40,58],[44,52],[48,46],[52,42],[56,38],[60,36],[64,38],[68,42],[70,50],[72,58],[74,70],[76,82],[78,95],[77,100]],
            // Australia (detailed)
            [[-11,143],[-13,147],[-17,150],[-21,152],[-25,153],[-29,153],[-33,151],[-36,148],[-38,146],[-39,144],[-38,140],[-37,137],[-35,134],[-32,130],[-28,126],[-24,122],[-20,118],[-16,116],[-13,118],[-12,122],[-11,127],[-10,132],[-11,138],[-11,143]],
            // Greenland
            [[84,-40],[82,-30],[80,-22],[77,-18],[74,-20],[72,-25],[70,-30],[68,-35],[66,-42],[65,-48],[66,-52],[68,-55],[70,-58],[72,-60],[74,-58],[76,-54],[78,-48],[80,-42],[82,-38],[84,-40]],
            // UK/Ireland
            [[59,-6],[58,-3],[56,0],[54,-3],[52,-5],[51,-8],[52,-10],[54,-10],[56,-8],[58,-7],[59,-6]],
            // Japan
            [[45,145],[43,146],[40,142],[36,140],[34,136],[33,132],[34,130],[36,132],[38,136],[40,140],[42,143],[45,145]],
            // Indonesia/SE Asia
            [[6,95],[4,100],[2,105],[0,110],[-2,115],[-5,118],[-8,120],[-6,125],[-4,128],[-2,130],[0,128],[2,125],[4,120],[5,115],[6,110],[6,105],[6,95]],
            // New Zealand
            [[-34,172],[-37,175],[-40,177],[-44,172],[-46,168],[-45,166],[-42,170],[-38,174],[-34,172]]
        ];

        // Draw filled continents
        ctx.fillStyle = 'rgba(16, 185, 129, 0.08)';
        ctx.strokeStyle = 'rgba(16, 185, 129, 0.25)';
        ctx.lineWidth = 1.5;

        continents.forEach(points => {
            ctx.beginPath();
            let first = true;
            let hasVisible = false;
            points.forEach(([lat, lon]) => {
                const p = project(lat, lon);
                if (p.visible) {
                    hasVisible = true;
                    if (first) {
                        ctx.moveTo(p.x, p.y);
                        first = false;
                    } else {
                        ctx.lineTo(p.x, p.y);
                    }
                } else if (!first) {
                    first = true;
                }
            });
            if (hasVisible) {
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }
        });
    }

    function drawFireRiskZones() {
        // Draw fire risk zones with animated glow
        datacenters.filter(dc => dc.fire > 0.5).forEach(dc => {
            const p = project(dc.lat, dc.lon);
            if (!p.visible) return;

            const radius = 20 + dc.fire * 40;
            const intensity = 0.1 + Math.sin(time * 0.003 + dc.lat) * 0.05;

            const gradient = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, radius * zoom);
            gradient.addColorStop(0, `rgba(231, 76, 60, ${intensity * dc.fire})`);
            gradient.addColorStop(0.5, `rgba(231, 76, 60, ${intensity * dc.fire * 0.3})`);
            gradient.addColorStop(1, 'rgba(231, 76, 60, 0)');

            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(p.x, p.y, radius * zoom, 0, Math.PI * 2);
            ctx.fill();
        });
    }

    function drawWaterStress() {
        // Draw water stress indicators
        datacenters.filter(dc => dc.water > 3).forEach(dc => {
            const p = project(dc.lat, dc.lon);
            if (!p.visible) return;

            const radius = 15 + dc.water * 8;
            const intensity = 0.1 + Math.sin(time * 0.002 + dc.lon) * 0.03;

            ctx.strokeStyle = `rgba(52, 152, 219, ${intensity * (dc.water / 6)})`;
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.arc(p.x, p.y, radius * zoom, 0, Math.PI * 2);
            ctx.stroke();
            ctx.setLineDash([]);
        });
    }

    function drawDatacenters() {
        datacenters.forEach((dc, idx) => {
            const p = project(dc.lat, dc.lon);
            if (!p.visible) return;

            const isSelected = selectedDC === idx;
            const baseRadius = 4 + (dc.capacity / 150);
            const radius = (isSelected ? baseRadius * 1.5 : baseRadius) * zoom;

            // Provider colors
            const colors = {
                'AWS': '#ff9900',
                'Google': '#4285f4',
                'Azure': '#00a1f1',
                'Meta': '#1877f2'
            };

            // Glow effect
            const glowRadius = radius * 3;
            const gradient = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, glowRadius);
            gradient.addColorStop(0, `${colors[dc.provider]}66`);
            gradient.addColorStop(1, 'transparent');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(p.x, p.y, glowRadius, 0, Math.PI * 2);
            ctx.fill();

            // Core dot
            ctx.fillStyle = colors[dc.provider];
            ctx.beginPath();
            ctx.arc(p.x, p.y, radius, 0, Math.PI * 2);
            ctx.fill();

            // Pulse ring
            const pulsePhase = (time * 0.002 + idx * 0.5) % (Math.PI * 2);
            const pulseRadius = radius + Math.sin(pulsePhase) * 5;
            const pulseOpacity = 0.5 - (pulsePhase / (Math.PI * 2)) * 0.5;
            ctx.strokeStyle = `rgba(255, 255, 255, ${pulseOpacity})`;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(p.x, p.y, pulseRadius * zoom, 0, Math.PI * 2);
            ctx.stroke();

            // Store click region
            dc._screenX = p.x;
            dc._screenY = p.y;
            dc._radius = radius * 2;
        });
    }

    function drawImpactRadius() {
        if (selectedDC === null) return;

        const dc = datacenters[selectedDC];
        const p = project(dc.lat, dc.lon);
        if (!p.visible) return;

        // Animated expanding rings showing impact
        for (let i = 0; i < 3; i++) {
            const phase = ((time * 0.001 + i * 0.33) % 1);
            const radius = (50 + phase * 150) * zoom;
            const opacity = 0.3 * (1 - phase);

            ctx.strokeStyle = `rgba(255, 107, 53, ${opacity})`;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(p.x, p.y, radius, 0, Math.PI * 2);
            ctx.stroke();
        }
    }

    function updateStats() {
        const totalWater = datacenters.reduce((sum, dc) => sum + dc.water, 0);
        const totalPower = datacenters.reduce((sum, dc) => sum + dc.capacity, 0) / 1000;
        const highFireRisk = datacenters.filter(dc => dc.fire > 0.5).length;
        const avgDrought = datacenters.reduce((sum, dc) => sum + dc.water * dc.fire, 0) / datacenters.length;

        document.getElementById('dcCount').textContent = datacenters.length;
        document.getElementById('waterUsage').textContent = `${totalWater.toFixed(1)} ML/day`;
        document.getElementById('powerDraw').textContent = `${totalPower.toFixed(1)} GW`;
        document.getElementById('fireRisk').textContent = highFireRisk;
        document.getElementById('droughtIdx').textContent = avgDrought.toFixed(2);

        // Token counter (simulated)
        tokens += Math.random() * 50;
        document.getElementById('tokenCount').textContent = Math.floor(tokens).toLocaleString();
        document.getElementById('tokenWater').textContent = `${(tokens * 0.0005).toFixed(2)} L`;
        document.getElementById('tokenCO2').textContent = `${(tokens * 0.002).toFixed(1)} g`;
    }

    function showDetail(idx) {
        selectedDC = idx;
        const dc = datacenters[idx];
        const panel = document.getElementById('detailPanel');

        document.getElementById('dcName').textContent = dc.name;
        document.getElementById('dcProvider').textContent = dc.provider;
        document.getElementById('dcCapacity').textContent = `${dc.capacity} MW`;
        document.getElementById('dcWater').textContent = `${dc.water} ML`;
        document.getElementById('dcPower').textContent = `${dc.capacity} MW`;

        document.getElementById('dcFireBar').style.width = `${dc.fire * 100}%`;
        document.getElementById('dcDroughtBar').style.width = `${(dc.water / 6) * 100}%`;
        document.getElementById('dcGridBar').style.width = `${(dc.capacity / 600) * 100}%`;

        panel.classList.add('visible');
    }

    function closeDetail() {
        selectedDC = null;
        document.getElementById('detailPanel').classList.remove('visible');
    }

    function handleClick(e) {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        for (let i = 0; i < datacenters.length; i++) {
            const dc = datacenters[i];
            if (dc._screenX && dc._screenY) {
                const dist = Math.sqrt((x - dc._screenX) ** 2 + (y - dc._screenY) ** 2);
                if (dist < dc._radius) {
                    showDetail(i);
                    return;
                }
            }
        }
        closeDetail();
    }

    function handleScroll(e) {
        e.preventDefault();
        zoom = Math.max(0.5, Math.min(3, zoom - e.deltaY * 0.001));
    }

    function handleMouseMove(e) {
        if (e.buttons === 1) {
            targetRotation += e.movementX * 0.5;
        }
    }

    function draw() {
        time++;
        rotation += (targetRotation - rotation) * 0.1;
        targetRotation *= 0.99; // Slow down

        ctx.fillStyle = 'rgba(10, 10, 15, 0.1)';
        ctx.fillRect(0, 0, width, height);

        drawFireRiskZones();
        drawWaterStress();
        drawGlobe();
        drawDatacenters();
        drawImpactRadius();

        if (time % 30 === 0) updateStats();

        requestAnimationFrame(draw);
    }

    // Initialize
    resize();
    window.addEventListener('resize', resize);
    canvas.addEventListener('click', handleClick);
    canvas.addEventListener('wheel', handleScroll, { passive: false });
    canvas.addEventListener('mousemove', handleMouseMove);

    // Auto-rotate slowly
    setInterval(() => {
        if (!document.hasFocus()) return;
        targetRotation += 0.1;
    }, 50);

    draw();
    </script>
</body>
</html>
