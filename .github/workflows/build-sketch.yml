name: Build Sketch

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write
  pages: write
  id-token: write

jobs:
  build:
    # Only run for issues with 'sketch' label
    if: contains(github.event.issue.labels.*.name, 'sketch')
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-action@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build hyle
        run: cargo build --release

      - name: Extract sketch from issue
        id: sketch
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Extract project name from title (remove [sketch] prefix)
          PROJECT_NAME=$(echo "$ISSUE_TITLE" | sed 's/^\[sketch\] //' | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd 'a-z0-9-')
          if [ -z "$PROJECT_NAME" ] || [ ${#PROJECT_NAME} -lt 2 ]; then
            PROJECT_NAME="project-$ISSUE_NUMBER"
          fi
          echo "name=$PROJECT_NAME" >> $GITHUB_OUTPUT

          # Write sketch to file
          echo "$ISSUE_BODY" > sketch.md
          echo "Sketch saved to sketch.md"
          cat sketch.md

      - name: Create project directory
        run: |
          mkdir -p projects/${{ steps.sketch.outputs.name }}

      - name: Run hyle on sketch
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          HYLE_MODEL: "meta-llama/llama-3.1-8b-instruct:free"
        run: |
          cd projects/${{ steps.sketch.outputs.name }}

          # Run hyle with the sketch
          # Using --trust to auto-approve tool calls in CI
          ../../target/release/hyle --trust "$(cat ../../sketch.md)" 2>&1 | tee build.log || true

          # If hyle created files, we're good
          if [ "$(ls -A . 2>/dev/null)" ]; then
            echo "Project files created successfully"
            ls -la
          else
            echo "No files created, creating placeholder"
            echo "# ${{ steps.sketch.outputs.name }}" > README.md
            echo "" >> README.md
            echo "Build in progress. Check the [GitHub Action](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for status." >> README.md
          fi

      - name: Create project index page
        run: |
          cd projects/${{ steps.sketch.outputs.name }}

          # Create a simple index.html if none exists
          if [ ! -f index.html ] && [ ! -f public/index.html ]; then
            cat > index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${{ steps.sketch.outputs.name }}</title>
            <style>
              body { font-family: system-ui; background: #111; color: #e8e8e8; padding: 2rem; max-width: 65ch; margin: 0 auto; }
              pre { background: #1a1a1a; padding: 1rem; overflow-x: auto; border-radius: 4px; }
              a { color: #6b9fff; }
            </style>
          </head>
          <body>
            <h1>${{ steps.sketch.outputs.name }}</h1>
            <p>Built by <a href="https://hyle.lol">hyle</a> from <a href="https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }}">issue #${{ github.event.issue.number }}</a>.</p>
            <h2>Files</h2>
            <pre>$(ls -la)</pre>
            <p><a href="https://github.com/${{ github.repository }}/tree/main/projects/${{ steps.sketch.outputs.name }}">View source</a></p>
          </body>
          </html>
          HTMLEOF
          fi

      - name: Commit project
        run: |
          git config user.name "hyle-bot"
          git config user.email "hyle-bot@users.noreply.github.com"
          git add projects/
          git commit -m "Build project: ${{ steps.sketch.outputs.name }} (#${{ github.event.issue.number }})" || echo "Nothing to commit"
          git push

      - name: Comment on issue with result
        uses: actions/github-script@v7
        with:
          script: |
            const projectName = '${{ steps.sketch.outputs.name }}';
            const projectUrl = `https://uprootiny.github.io/hyle/projects/${projectName}/`;
            const sourceUrl = `https://github.com/${{ github.repository }}/tree/main/projects/${projectName}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## Project Built\n\n` +
                    `Your project **${projectName}** has been created.\n\n` +
                    `- [View deployed project](${projectUrl})\n` +
                    `- [View source code](${sourceUrl})\n` +
                    `- [Build log](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n` +
                    `Built by [hyle](https://hyle.lol) using free LLMs.`
            });

            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });

      - name: Update projects index
        run: |
          # Create/update projects index page
          cat > projects/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>hyle projects</title>
            <style>
              body { font-family: system-ui; background: #111; color: #e8e8e8; padding: 2rem; max-width: 65ch; margin: 0 auto; }
              a { color: #6b9fff; }
              ul { list-style: none; padding: 0; }
              li { padding: 0.5rem 0; border-bottom: 1px solid #333; }
            </style>
          </head>
          <body>
            <h1>hyle projects</h1>
            <p>Projects built from <a href="https://hyle.lol">hyle.lol</a> sketches.</p>
            <ul>
          EOF

          # List all project directories
          for dir in projects/*/; do
            if [ -d "$dir" ]; then
              name=$(basename "$dir")
              if [ "$name" != "index.html" ]; then
                echo "    <li><a href=\"$name/\">$name</a></li>" >> projects/index.html
              fi
            fi
          done

          cat >> projects/index.html << 'EOF'
            </ul>
            <p><a href="/">Submit a new sketch</a></p>
          </body>
          </html>
          EOF

          git add projects/index.html
          git commit -m "Update projects index" || echo "No index changes"
          git push
