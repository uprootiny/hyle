name: Build Sketch

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write
  pages: write
  id-token: write

env:
  # Free models to cycle through (in order of preference)
  FREE_MODELS: |
    meta-llama/llama-3.1-8b-instruct:free
    google/gemma-2-9b-it:free
    mistralai/mistral-7b-instruct:free
    huggingfaceh4/zephyr-7b-beta:free
    openchat/openchat-7b:free

jobs:
  build:
    # Only run for issues with 'sketch' label
    if: contains(github.event.issue.labels.*.name, 'sketch')
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-action@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build hyle
        run: cargo build --release

      - name: Extract sketch from issue
        id: sketch
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Extract project name from title (remove [sketch] prefix)
          PROJECT_NAME=$(echo "$ISSUE_TITLE" | sed 's/^\[sketch\] //' | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -cd 'a-z0-9-')
          if [ -z "$PROJECT_NAME" ] || [ ${#PROJECT_NAME} -lt 2 ]; then
            PROJECT_NAME="project-$ISSUE_NUMBER"
          fi
          echo "name=$PROJECT_NAME" >> $GITHUB_OUTPUT

          # Write sketch to file
          echo "$ISSUE_BODY" > sketch.md
          echo "Sketch saved to sketch.md"
          cat sketch.md

      - name: Create project directory
        run: |
          mkdir -p projects/${{ steps.sketch.outputs.name }}

      - name: Run hyle with model fallback
        id: hyle
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          cd projects/${{ steps.sketch.outputs.name }}

          # Models to try (free tier)
          MODELS=(
            "meta-llama/llama-3.1-8b-instruct:free"
            "google/gemma-2-9b-it:free"
            "mistralai/mistral-7b-instruct:free"
            "huggingfaceh4/zephyr-7b-beta:free"
            "openchat/openchat-7b:free"
          )

          SKETCH=$(cat ../../sketch.md)
          SUCCESS=false
          USED_MODEL=""

          for MODEL in "${MODELS[@]}"; do
            echo "=============================================="
            echo "Trying model: $MODEL"
            echo "=============================================="

            export HYLE_MODEL="$MODEL"

            # Run hyle with timeout per model attempt
            if timeout 300 ../../target/release/hyle --trust "$SKETCH" 2>&1 | tee -a build.log; then
              # Check if we got actual output (not just errors)
              if [ "$(ls -A . 2>/dev/null | grep -v build.log | head -1)" ]; then
                echo "Success with model: $MODEL"
                SUCCESS=true
                USED_MODEL="$MODEL"
                break
              fi
            fi

            echo "Model $MODEL failed or rate limited, trying next..."
            sleep 2
          done

          if [ "$SUCCESS" = true ]; then
            echo "model=$USED_MODEL" >> $GITHUB_OUTPUT
            echo "status=success" >> $GITHUB_OUTPUT
            echo "Project files created:"
            ls -la
          else
            echo "status=partial" >> $GITHUB_OUTPUT
            echo "All models exhausted, creating placeholder"
            cat > README.md << EOF
          # ${{ steps.sketch.outputs.name }}

          Build attempted but models were rate limited.
          Check the [build log](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).

          ## Original Sketch

          \`\`\`
          $SKETCH
          \`\`\`
          EOF
          fi

      - name: Create project index page
        run: |
          cd projects/${{ steps.sketch.outputs.name }}

          # Create a simple index.html if none exists
          if [ ! -f index.html ] && [ ! -f public/index.html ]; then
            MODEL="${{ steps.hyle.outputs.model }}"
            MODEL_INFO=""
            if [ -n "$MODEL" ]; then
              MODEL_INFO="<p style=\"color:#666;font-size:0.9rem\">Built with $MODEL</p>"
            fi

            cat > index.html << HTMLEOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${{ steps.sketch.outputs.name }}</title>
            <style>
              body { font-family: system-ui; background: #111; color: #e8e8e8; padding: 2rem; max-width: 65ch; margin: 0 auto; line-height: 1.6; }
              pre { background: #1a1a1a; padding: 1rem; overflow-x: auto; border-radius: 4px; font-size: 0.9rem; }
              a { color: #6b9fff; }
              h1 { font-weight: 400; }
            </style>
          </head>
          <body>
            <h1>${{ steps.sketch.outputs.name }}</h1>
            <p>Built by <a href="https://hyle.lol">hyle</a> from <a href="https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }}">issue #${{ github.event.issue.number }}</a>.</p>
            $MODEL_INFO
            <h2>Files</h2>
            <pre>$(ls -la | grep -v index.html)</pre>
            <p><a href="https://github.com/${{ github.repository }}/tree/master/projects/${{ steps.sketch.outputs.name }}">View source</a></p>
          </body>
          </html>
          HTMLEOF
          fi

      - name: Commit project
        run: |
          git config user.name "hyle-bot"
          git config user.email "hyle-bot@users.noreply.github.com"
          git add projects/
          git commit -m "Build project: ${{ steps.sketch.outputs.name }} (#${{ github.event.issue.number }})" || echo "Nothing to commit"
          git push

      - name: Comment on issue with result
        uses: actions/github-script@v7
        with:
          script: |
            const projectName = '${{ steps.sketch.outputs.name }}';
            const status = '${{ steps.hyle.outputs.status }}';
            const model = '${{ steps.hyle.outputs.model }}' || 'unknown';
            const projectUrl = `https://uprootiny.github.io/hyle/projects/${projectName}/`;
            const sourceUrl = `https://github.com/${{ github.repository }}/tree/master/projects/${projectName}`;

            let body;
            if (status === 'success') {
              body = `## Project Built ✓\n\n` +
                     `Your project **${projectName}** has been created.\n\n` +
                     `- [View deployed project](${projectUrl})\n` +
                     `- [View source code](${sourceUrl})\n` +
                     `- [Build log](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n` +
                     `Built with \`${model}\` via [hyle](https://hyle.lol).`;
            } else {
              body = `## Build Attempted\n\n` +
                     `Project **${projectName}** was created with partial results.\n\n` +
                     `All free models were rate limited. The sketch has been saved.\n\n` +
                     `- [View project](${projectUrl})\n` +
                     `- [Build log](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n` +
                     `Try again later or use a different model.`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });

      - name: Update projects index
        run: |
          cat > projects/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>hyle projects</title>
            <style>
              body { font-family: system-ui; background: #111; color: #e8e8e8; padding: 2rem; max-width: 65ch; margin: 0 auto; }
              a { color: #6b9fff; text-decoration: none; }
              a:hover { text-decoration: underline; }
              ul { list-style: none; padding: 0; }
              li { padding: 0.75rem 0; border-bottom: 1px solid #222; }
              li:last-child { border-bottom: none; }
              h1 { font-weight: 400; }
            </style>
          </head>
          <body>
            <h1>hyle projects</h1>
            <p style="color:#666">Projects built from <a href="/">hyle.lol</a> sketches.</p>
            <ul>
          EOF

          for dir in projects/*/; do
            if [ -d "$dir" ]; then
              name=$(basename "$dir")
              if [ "$name" != "index.html" ]; then
                echo "      <li><a href=\"$name/\">$name</a></li>" >> projects/index.html
              fi
            fi
          done

          cat >> projects/index.html << 'EOF'
            </ul>
            <p style="margin-top:2rem"><a href="/">← Submit a new sketch</a></p>
          </body>
          </html>
          EOF

          git add projects/index.html
          git commit -m "Update projects index" || echo "No index changes"
          git push
